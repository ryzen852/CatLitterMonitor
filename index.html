<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>ğŸ± è²“è²“å»æ‰€ç›£å¯Ÿç«™</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#080c12;--surface:#0e1520;--surface2:#141e2e;--border:#1e2d42;--teal:#00e5b0;--teal-dim:#00a87e;--teal-glow:rgba(0,229,176,0.12);--amber:#ffb74d;--red:#ff5252;--blue:#4dd0e1;--text:#c8d8e8;--text-dim:#5a7a96;--text-bright:#e8f4ff;--mono:'Space Mono',monospace;--sans:'Syne',sans-serif}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);font-family:var(--mono);min-height:100dvh;display:flex;flex-direction:column;overflow:hidden}
header{padding:10px 14px 0;display:flex;align-items:center;gap:8px;flex-shrink:0}
header h1{font-family:var(--sans);font-weight:800;font-size:17px;color:var(--text-bright);letter-spacing:-.5px;flex:1}
header h1 span{color:var(--teal)}
.lang-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);font-family:var(--mono);font-size:10px;padding:4px 9px;border-radius:6px;cursor:pointer;transition:all .2s}
.lang-btn:hover{border-color:var(--teal);color:var(--teal)}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--text-dim);flex-shrink:0;transition:background .3s}
.status-dot.active{background:var(--teal);box-shadow:0 0 8px var(--teal);animation:pulse 2s infinite}
.status-dot.motion{background:var(--amber);box-shadow:0 0 8px var(--amber);animation:pulse .5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
nav{display:flex;padding:8px 14px 0;gap:3px;flex-shrink:0;border-bottom:1px solid var(--border);overflow-x:auto}
nav::-webkit-scrollbar{display:none}
nav button{background:none;border:none;color:var(--text-dim);font-family:var(--mono);font-size:11px;padding:7px 11px;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .2s;white-space:nowrap}
nav button.active{color:var(--teal);border-bottom-color:var(--teal)}
.pages{flex:1;overflow:hidden;position:relative}
.page{position:absolute;inset:0;overflow-y:auto;padding:14px;display:none}
.page.active{display:block}
.camera-wrap{position:relative;background:#000;border-radius:12px;overflow:hidden;border:1px solid var(--border);aspect-ratio:4/3;max-height:270px}
#videoEl{width:100%;height:100%;object-fit:cover;display:block}
#roiCanvas{position:absolute;inset:0;width:100%;height:100%;cursor:crosshair;touch-action:none}
.cam-overlay{position:absolute;top:8px;left:8px;background:rgba(8,12,18,.8);border:1px solid var(--border);border-radius:6px;padding:3px 8px;font-size:10px;color:var(--teal);backdrop-filter:blur(4px)}
.cam-status{position:absolute;bottom:8px;right:8px;background:rgba(8,12,18,.85);border-radius:6px;padding:3px 9px;font-size:10px;color:var(--text-dim)}
.cam-status.in-session{color:var(--amber);border:1px solid var(--amber)}
.cam-status.analyzing{color:var(--blue);border:1px solid var(--blue)}
.btn{background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:11px;padding:8px 13px;border-radius:8px;cursor:pointer;transition:all .2s;white-space:nowrap}
.btn:hover{border-color:var(--teal);color:var(--teal)}
.btn.primary{background:var(--teal);color:#080c12;border-color:var(--teal);font-weight:700}
.btn.primary:hover{background:var(--teal-dim)}
.btn.danger{border-color:var(--red);color:var(--red)}
.btn.sm{padding:5px 10px;font-size:10px}
.btn:disabled{opacity:.4;cursor:default}
.monitor-controls{display:flex;gap:8px;margin-top:10px}
.hint{font-size:10px;color:var(--text-dim);margin-top:5px;text-align:center}
.motion-meter-wrap{margin-top:11px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:11px}
.meter-label{display:flex;justify-content:space-between;font-size:10px;color:var(--text-dim);margin-bottom:5px}
.meter-bar{height:6px;background:var(--surface2);border-radius:3px;overflow:hidden}
.meter-fill{height:100%;background:var(--teal);border-radius:3px;transition:width .2s;width:0%}
.meter-fill.hot{background:var(--amber)}
.meter-fill.fire{background:var(--red)}
.session-card{margin-top:11px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px;display:none}
.session-card.visible{display:block;border-color:var(--amber)}
.session-title{font-family:var(--sans);font-size:13px;color:var(--amber);font-weight:700;margin-bottom:8px}
.session-info{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:11px}
.info-item label{color:var(--text-dim);display:block;font-size:9px;margin-bottom:2px}
.section-title{font-family:var(--sans);font-size:13px;font-weight:700;color:var(--text-bright);margin:14px 0 7px}
.event-list{display:flex;flex-direction:column;gap:6px}
.event-item{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:9px 11px;display:flex;align-items:center;gap:9px}
.cat-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.event-body{flex:1;min-width:0}
.event-title{font-size:12px;color:var(--text-bright)}
.event-sub{font-size:10px;color:var(--text-dim);margin-top:2px}
.event-time{font-size:10px;color:var(--text-dim);flex-shrink:0}
.badge{padding:2px 7px;border-radius:4px;font-size:9px;font-weight:700;flex-shrink:0}
.badge.pee{background:rgba(77,208,225,.2);color:var(--blue)}
.badge.poop{background:rgba(255,183,77,.2);color:var(--amber)}
.badge.visit{background:var(--teal-glow);color:var(--teal)}
.badge.alert{background:rgba(255,82,82,.2);color:var(--red)}
.no-events{font-size:11px;color:var(--text-dim);text-align:center;padding:20px}
.settings-section{margin-bottom:20px}
.settings-section-title{font-family:var(--sans);font-size:11px;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.field{margin-bottom:10px}
.field label{display:block;font-size:10px;color:var(--text-dim);margin-bottom:5px}
.field input,.field select,.field textarea{width:100%;background:var(--surface);border:1px solid var(--border);color:var(--text-bright);font-family:var(--mono);font-size:12px;padding:9px 11px;border-radius:8px;outline:none;transition:border-color .2s}
.field select option{background:var(--surface2)}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--teal)}
.field input[type=range]{padding:0;background:none;border:none;cursor:pointer}
.range-labels{display:flex;justify-content:space-between;font-size:9px;color:var(--text-dim);margin-top:2px}
.field-hint{font-size:10px;color:var(--text-dim);margin-top:4px;line-height:1.5;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:6px 9px}
.test-btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
/* MULTI-CAT */
.cat-cards{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
.cat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;transition:border-color .2s}
.cat-card.open{border-color:var(--border)}
.cat-card-header{display:flex;align-items:center;gap:9px;padding:11px 13px;cursor:pointer;user-select:none}
.cat-name-display{flex:1;font-size:13px;color:var(--text-bright);font-weight:700}
.cat-breed-display{font-size:10px;color:var(--text-dim)}
.cat-card-chevron{font-size:11px;color:var(--text-dim);transition:transform .2s;flex-shrink:0}
.cat-card.open .cat-card-chevron{transform:rotate(180deg)}
.cat-card-body{padding:0 13px 13px;display:none}
.cat-card.open .cat-card-body{display:block}
.photo-row{display:flex;gap:10px;align-items:flex-start;margin-bottom:10px}
.photo-thumb{flex-shrink:0;width:62px;height:62px;border-radius:10px;border:2px dashed var(--border);background:var(--surface2);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;position:relative;overflow:hidden;transition:border-color .2s}
.photo-thumb:hover{border-color:var(--teal)}
.photo-thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.photo-thumb .pi{font-size:18px;pointer-events:none}
.photo-thumb .pl{font-size:8px;color:var(--text-dim);margin-top:1px;pointer-events:none}
.photo-thumb input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;padding:0;background:none;border:none}
.cat-fields{flex:1;display:flex;flex-direction:column;gap:6px}
.cat-fields input,.cat-fields select,.cat-fields textarea{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text-bright);font-family:var(--mono);font-size:11px;padding:7px 10px;border-radius:8px;outline:none;resize:vertical;transition:border-color .2s}
.cat-fields select option{background:var(--surface2)}
.cat-fields input:focus,.cat-fields select:focus,.cat-fields textarea:focus{border-color:var(--teal)}
.cat-footer{display:flex;align-items:center;gap:10px;margin-top:4px}
.cat-delete-btn{background:none;border:1px solid rgba(255,82,82,.4);color:var(--red);font-size:10px;padding:4px 9px;border-radius:6px;cursor:pointer;font-family:var(--mono);transition:all .2s;margin-left:auto}
.cat-delete-btn:hover{background:rgba(255,82,82,.1)}
.add-cat-btn{width:100%;background:var(--teal-glow);border:1px dashed var(--teal-dim);color:var(--teal);font-family:var(--mono);font-size:12px;padding:10px;border-radius:10px;cursor:pointer;transition:all .2s}
.add-cat-btn:hover{background:rgba(0,229,176,.2)}
.id-tip{font-size:10px;color:var(--text-dim);background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 10px;margin-bottom:10px;line-height:1.6}
.id-tip strong{color:var(--teal)}
/* LOG */
.log-filter{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
.filter-btn{background:var(--surface);border:1px solid var(--border);color:var(--text-dim);font-family:var(--mono);font-size:10px;padding:5px 10px;border-radius:6px;cursor:pointer;transition:all .2s}
.filter-btn.active{border-color:var(--teal);color:var(--teal);background:var(--teal-glow)}
.log-date-group{margin-bottom:14px}
.log-date-label{font-size:10px;color:var(--text-dim);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px}
.log-entry{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:5px}
.log-entry-header{display:flex;align-items:center;gap:8px;margin-bottom:5px}
.log-entry-notes{font-size:10px;color:var(--text-dim);line-height:1.5;font-style:italic}
.log-ident{font-size:10px;color:var(--teal-dim);margin-top:3px}
.log-entry-meta{display:flex;gap:12px;margin-top:5px;font-size:10px;color:var(--text-dim)}
.alert-card{background:rgba(255,82,82,.08);border:1px solid rgba(255,82,82,.3);border-radius:8px;padding:8px 10px;margin-top:5px}
.alert-card.warn{background:rgba(255,183,77,.08);border-color:rgba(255,183,77,.3)}
.alert-title{font-size:11px;color:var(--red);font-weight:700;margin-bottom:3px}
.alert-card.warn .alert-title{color:var(--amber)}
.alert-body{font-size:10px;color:var(--text)}
/* STATS */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:11px}
.stat-val{font-family:var(--sans);font-size:26px;font-weight:800;color:var(--teal);line-height:1;margin-bottom:3px}
.stat-label{font-size:10px;color:var(--text-dim)}
.cat-panel{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px}
.cat-panel-header{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.cat-avatar{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px}
.cat-panel-name{font-family:var(--sans);font-weight:700;font-size:13px;color:var(--text-bright)}
.cat-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.mini-stat{text-align:center}
.mini-stat .val{font-size:17px;font-weight:700;color:var(--teal);font-family:var(--sans)}
.mini-stat .lbl{font-size:9px;color:var(--text-dim)}
.timeline-wrap{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px}
.timeline-hours{display:flex;justify-content:space-between;font-size:9px;color:var(--text-dim);margin-bottom:7px}
.timeline-row{display:flex;align-items:center;gap:8px;margin-bottom:5px}
.timeline-cat-label{font-size:10px;color:var(--text-dim);width:50px;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.timeline-bar{flex:1;height:18px;background:var(--surface2);border-radius:4px;position:relative;overflow:hidden}
.timeline-event{position:absolute;top:2px;bottom:2px;border-radius:3px;min-width:4px}
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--surface2);border:1px solid var(--border);color:var(--text-bright);font-size:12px;padding:9px 18px;border-radius:20px;transition:transform .3s;z-index:999;white-space:nowrap;max-width:90vw;text-align:center}
#toast.show{transform:translateX(-50%) translateY(0)}
#toast.success{border-color:var(--teal);color:var(--teal)}
#toast.error{border-color:var(--red);color:var(--red)}
#setupOverlay{position:fixed;inset:0;background:var(--bg);z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 24px;text-align:center}
#setupOverlay.hidden{display:none}
#setupOverlay h2{font-family:var(--sans);font-size:22px;font-weight:800;color:var(--text-bright);margin-bottom:8px}
#setupOverlay p{font-size:12px;color:var(--text-dim);margin-bottom:20px;line-height:1.6}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.empty{text-align:center;padding:36px 20px;color:var(--text-dim);font-size:12px}
.empty-icon{font-size:36px;margin-bottom:10px}
/* WASTE ANALYSIS PANEL */
.waste-panel{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:9px 11px;margin-top:6px}
.waste-panel-title{font-size:10px;color:var(--teal-dim);font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.waste-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.waste-item{font-size:10px}
.waste-item .wlabel{color:var(--text-dim);display:block;margin-bottom:1px;font-size:9px}
.waste-item .wval{color:var(--text-bright)}
.waste-item .wval.warn{color:var(--amber)}
.waste-item .wval.alert{color:var(--red)}
.waste-flag{display:inline-block;background:rgba(255,82,82,.15);border:1px solid rgba(255,82,82,.3);color:var(--red);font-size:9px;padding:2px 6px;border-radius:4px;margin:2px 2px 0 0}
.waste-flag.warn{background:rgba(255,183,77,.15);border-color:rgba(255,183,77,.3);color:var(--amber)}
</style>
</head>
<body>

<div id="setupOverlay">
  <div style="font-size:44px;margin-bottom:14px">ğŸ±</div>
  <h2 id="so-title">è²“è²“å»æ‰€ç›£å¯Ÿç«™</h2>
  <p id="so-desc">è«‹å…ˆåˆ°ã€Œè¨­å®šã€å¡«å¯« Claude API Key<br>åŠè²“è²“è³‡æ–™ï¼Œå†å•Ÿå‹•ç›£å¯Ÿ</p>
  <button class="btn primary" style="margin-top:8px" onclick="document.getElementById('setupOverlay').classList.add('hidden');switchTab('settings')" id="so-go">å‰å¾€è¨­å®š â†’</button>
  <button class="btn" style="margin-top:8px" onclick="document.getElementById('setupOverlay').classList.add('hidden')" id="so-skip">æˆ‘å·²è¨­å®šå¥½</button>
</div>

<header>
  <div style="font-size:20px">ğŸ±</div>
  <h1 id="hdr-title">è²“è²“<span>å»æ‰€</span>ç›£å¯Ÿ</h1>
  <button class="lang-btn" onclick="toggleLang()" id="langBtn">EN</button>
  <div class="status-dot" id="statusDot"></div>
</header>

<nav>
  <button class="active" onclick="switchTab('monitor')" id="tab-monitor">ğŸ“· ç›£å¯Ÿ</button>
  <button onclick="switchTab('log')" id="tab-log">ğŸ“‹ è¨˜éŒ„</button>
  <button onclick="switchTab('stats')" id="tab-stats">ğŸ“Š åˆ†æ</button>
  <button onclick="switchTab('settings')" id="tab-settings">âš™ï¸ è¨­å®š</button>
</nav>

<div class="pages">

<!-- MONITOR -->
<div class="page active" id="page-monitor">
  <div class="camera-wrap">
    <video id="videoEl" autoplay muted playsinline></video>
    <canvas id="roiCanvas"></canvas>
    <div class="cam-overlay" id="camOverlay">å¾…æ©Ÿä¸­</div>
    <div class="cam-status" id="camStatus">æœªå•Ÿå‹•</div>
  </div>
  <div class="hint" id="roiHint">å•Ÿå‹•å¾Œé•·æŒ‰æ‹–æ›³è¨­å®šè²“ç ‚ç›¤ç¯„åœ</div>
  <div class="monitor-controls">
    <button class="btn primary" id="btnStart" onclick="startCamera()" style="flex:1">ğŸ¥ å•Ÿå‹•ç›£å¯Ÿ</button>
    <button class="btn" id="btnStop" onclick="stopCamera()" disabled>â¹ åœæ­¢</button>
  </div>
  <div class="motion-meter-wrap">
    <div class="meter-label"><span id="motionLabel">å‹•æ…‹åµæ¸¬</span><span id="motionVal">0%</span></div>
    <div class="meter-bar"><div class="meter-fill" id="motionFill"></div></div>
  </div>
  <div class="session-card" id="sessionCard">
    <div class="session-title">ğŸ”´ <span id="sessionActiveLabel">é€²è¡Œä¸­</span> â€” <span id="sessionCatName">...</span></div>
    <div class="session-info">
      <div class="info-item"><label id="startTimeLabel">é–‹å§‹æ™‚é–“</label><span id="sessionStart">â€”</span></div>
      <div class="info-item"><label id="durationLabel">æŒçºŒæ™‚é–“</label><span id="sessionDur">0s</span></div>
      <div class="info-item"><label id="activityLabel">æ´»å‹•åˆ¤æ–·</label><span id="sessionActivity">...</span></div>
      <div class="info-item"><label id="confidenceLabel">ä¿¡å¿ƒåº¦</label><span id="sessionConf">â€”</span></div>
    </div>
  </div>
  <div class="section-title" id="recentTitle">æœ€è¿‘è¨˜éŒ„</div>
  <div class="event-list" id="recentEvents"><div class="no-events" id="noRecordsMsg">å°šç„¡è¨˜éŒ„</div></div>
</div>

<!-- LOG -->
<div class="page" id="page-log">
  <div class="log-filter" id="logFilterRow"></div>
  <div id="logContainer"><div class="empty"><div class="empty-icon">ğŸ“‹</div><span id="logEmptyMsg">è¨˜éŒ„æœƒåœ¨è²“è²“ä½¿ç”¨å»æ‰€å¾Œå‡ºç¾</span></div></div>
  <button class="btn danger" style="width:100%;margin-top:14px" onclick="clearAllLogs()" id="clearLogsBtn">æ¸…é™¤æ‰€æœ‰è¨˜éŒ„</button>
</div>

<!-- STATS -->
<div class="page" id="page-stats">
  <div id="statsContainer"><div class="empty"><div class="empty-icon">ğŸ“Š</div><span id="statsEmptyMsg">æ”¶é›†åˆ°è¨˜éŒ„å¾Œæœƒé¡¯ç¤ºçµ±è¨ˆ</span></div></div>
</div>

<!-- SETTINGS -->
<div class="page" id="page-settings">
  <div class="settings-section">
    <div class="settings-section-title" id="sectionAPI">ğŸ”‘ API è¨­å®š</div>
    <div class="field">
      <label id="apiKeyLabel">Claude API Key</label>
      <input type="password" id="apiKey" placeholder="sk-ant-...">
    </div>
    <div class="field">
      <label id="modelLabel">Claude æ¨¡å‹</label>
      <select id="apiModel">
        <option value="claude-haiku-3-5-20251001" id="modelHaikuOpt">claude-haiku-3-5ï¼ˆ~$0.40/é€±ï¼Œæ¨è–¦ï¼‰</option>
        <option value="claude-sonnet-4-5-20251022" id="modelSonnetOpt">claude-sonnet-4-5ï¼ˆ~$1.50/é€±ï¼Œæ›´æº–ï¼‰</option>
      </select>
    </div>
  </div>

  <div class="settings-section">
    <div class="settings-section-title" id="sectionCats">ğŸ± è²“è²“è­˜åˆ¥è³‡æ–™</div>
    <div class="id-tip" id="idTip">
      <strong>è­˜åˆ¥æº–ç¢ºåº¦ï¼š</strong>ä¸Šè¼‰æ¸…æ™°åƒè€ƒç›¸ + å¡«å¯«å“ç¨® + æè¿°ç¨ç‰¹ç‰¹å¾µ<br>
      è‹¥çœŸä¿‚åˆ†å””æ¸…ï¼Œæœƒè¨˜ç‚ºã€ŒæœªçŸ¥ã€ï¼Œå””æœƒäº‚ä¼°
    </div>
    <div class="cat-cards" id="catCards"></div>
    <button class="add-cat-btn" onclick="addCat()" id="addCatBtn">ï¼‹ æ–°å¢è²“è²“</button>
  </div>

  <div class="settings-section">
    <div class="settings-section-title" id="sectionNotifMode">ğŸ“¬ é€šçŸ¥æ¨¡å¼</div>
    <div class="field">
      <label id="notifModeLabel">ç™¼é€é€šçŸ¥æ™‚æ©Ÿ</label>
      <select id="notifMode">
        <option value="all" id="notifAllOpt">æ¯æ¬¡å¦‚å»éƒ½ç™¼</option>
        <option value="alerts" id="notifAlertsOpt">åªç™¼å¥åº·è­¦å‘Š</option>
        <option value="daily" id="notifDailyOpt">æ¯æ—¥æ‘˜è¦ï¼ˆæ—©ä¸Š 8 æ™‚ï¼‰</option>
      </select>
    </div>
    <div class="field">
      <label id="noEliminationLabel">ç•°å¸¸æ¢è¨ªè­¦å‘Šï¼šè²“å’ªåœç•™å¤šå°‘ç§’ä½†å†‡æ’æ³„ï¼ˆ0 = åœç”¨ï¼‰</label>
      <input type="number" id="noEliminationSecs" value="90" min="0" max="300">
      <div class="field-hint" id="noEliminationHint">å»ºè­° 90 ç§’ã€‚è²“å…¥ç ‚ç›†å»å†‡å°¿å†‡ä¾¿å¯èƒ½ä¿‚å°¿é“é˜»å¡ç­‰ç·Šæ€¥æƒ…æ³</div>
    </div>
  </div>

  <div class="settings-section">
    <div class="settings-section-title" id="sectionNotif">ğŸ”” é€šçŸ¥è¨­å®š</div>
    <div class="field">
      <label>Discord Webhook URL</label>
      <input type="url" id="discordWebhook" placeholder="https://discord.com/api/webhooks/...">
    </div>
    <div class="field">
      <label>Telegram Bot Token</label>
      <input type="text" id="tgToken" placeholder="123456789:AABBcc...">
    </div>
    <div class="field">
      <label id="tgChatLabel">Telegram Chat ID</label>
      <input type="text" id="tgChatId" placeholder="-1001234567890">
    </div>
    <div class="test-btn-row">
      <button class="btn sm" onclick="testDiscord()" id="testDiscordBtn">æ¸¬è©¦ Discord</button>
      <button class="btn sm" onclick="testTelegram()" id="testTelegramBtn">æ¸¬è©¦ Telegram</button>
    </div>
  </div>

  <div class="settings-section">
    <div class="settings-section-title" id="sectionDetect">âš™ï¸ åµæ¸¬è¨­å®š</div>
    <div class="field">
      <label><span id="sensitivityLabel">å‹•æ…‹æ•æ„Ÿåº¦ï¼ˆæ•¸å€¼è¶Šä½è¶Šæ•æ„Ÿï¼‰</span> <span id="sensitivityVal" style="color:var(--teal)">15%</span></label>
      <input type="range" id="sensitivity" min="3" max="30" value="15" oninput="document.getElementById('sensitivityVal').textContent=this.value+'%'">
      <div class="range-labels"><span id="verySensitive">æ¥µæ•æ„Ÿ</span><span id="normalSens">ä¸€èˆ¬</span><span id="lowSensitive">ä½æ•æ„Ÿ</span></div>
    </div>
    <div class="field">
      <label id="triggerLabel">æŒçºŒéƒå‹•å¤šå°‘ç§’å¾Œé–‹å§‹ Sessionï¼ˆç§’ï¼‰</label>
      <input type="number" id="triggerDelay" value="3" min="1" max="10">
      <div class="field-hint" id="triggerHint">é¿å…çŸ­æš«éƒå‹•èª¤è§¸ç™¼ï¼Œå»ºè­° 3 ç§’</div>
    </div>
    <div class="field">
      <label id="sessionEndLabel">éœæ­¢å¤šå°‘ç§’å¾ŒçµæŸ Sessionï¼ˆç§’ï¼‰</label>
      <input type="number" id="sessionEndDelay" value="45" min="10" max="120">
      <div class="field-hint" id="sessionEndHint">è²“è²“é›¢é–‹ç ‚ç›¤å¾Œï¼Œç­‰å¤šå°‘ç§’å…ˆå„²å­˜å‘¢æ¬¡å¦‚å»è¨˜éŒ„ã€‚å»ºè­° 45 ç§’ï¼Œå› ç‚ºè²“å’ªæ©æ²™æ™‚æœƒçŸ­æš«åœæ­¢éƒå‹•ï¼Œå””æƒ³èª¤ä»¥ç‚ºä½¢å·²é›¢é–‹</div>
    </div>
  </div>

  <div class="settings-section">
    <div class="settings-section-title" id="sectionHealth">ğŸ¥ å¥åº·è­¦å‘Šè¨­å®š</div>
    <div class="field">
      <label id="alertNoVisitLabel">å¤šå°‘å°æ™‚ç„¡è¨˜éŒ„ç™¼è­¦å‘Šï¼ˆ0 = åœç”¨ï¼‰</label>
      <input type="number" id="alertNoVisit" value="24" min="0" max="72">
    </div>
    <div class="field">
      <label id="alertMaxDailyLabel">æ¯æ—¥å¦‚å»æ¬¡æ•¸ä¸Šé™ï¼ˆè¶…éç™¼è­¦å‘Šï¼‰</label>
      <input type="number" id="alertMaxDaily" value="8" min="3" max="20">
    </div>
    <div class="field">
      <label id="alertMaxDurLabel">å–®æ¬¡å¦‚å»æœ€é•·æ™‚é–“è­¦å‘Šï¼ˆåˆ†é˜ï¼‰</label>
      <input type="number" id="alertMaxDuration" value="15" min="5" max="60">
    </div>
  </div>

  <button class="btn primary" style="width:100%;margin-bottom:8px" onclick="saveSettings()" id="saveBtn">ğŸ’¾ å„²å­˜è¨­å®š</button>
  <button class="btn" style="width:100%" onclick="exportLogs()" id="exportBtn">ğŸ“¤ åŒ¯å‡ºè¨˜éŒ„ (JSON)</button>
</div>

</div>
<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// i18n
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BREEDS = {
  zh: ['ä¸é¸æ“‡ï¼ˆè‡ªè¡Œæè¿°ï¼‰','æš¹ç¾… Siamese','æ³¢æ–¯ Persian','ç·¬å› è²“ Maine Coon','è‹±åœ‹çŸ­æ¯› British Shorthair','è˜‡æ ¼è˜­æ‘ºè€³ Scottish Fold','ç¾åœ‹çŸ­æ¯› American Shorthair','å¸ƒå¶è²“ Ragdoll','å­ŸåŠ æ‹‰è²“ Bengal','é˜¿æ¯”è¥¿å°¼äº Abyssinian','ä¿„ç¾…æ–¯è—è²“ Russian Blue','æŒªå¨æ£®æ—è²“ Norwegian Forest','åœŸè€³å…¶æ¢µè²“ Turkish Van','æ±æ–¹çŸ­æ¯› Oriental Shorthair','ä¼¯æ›¼ Birman','æ–°åŠ å¡è²“ Singapura','è™æ–‘ Tabby','æ©˜è²“ Orange Tabby','ä¸‰èŠ± Calico','ç³ç‘ Tortoiseshell','ç´”é»‘ All Black','ç´”ç™½ All White','æ··ç¨® Mixed Breed'],
  en: ['No selection (describe manually)','Siamese','Persian','Maine Coon','British Shorthair','Scottish Fold','American Shorthair','Ragdoll','Bengal','Abyssinian','Russian Blue','Norwegian Forest Cat','Turkish Van','Oriental Shorthair','Birman','Singapura','Tabby','Orange Tabby','Calico','Tortoiseshell','All Black','All White','Mixed Breed']
};

const STRINGS = {
  zh: {
    appTitle:'è²“è²“å»æ‰€ç›£å¯Ÿ',hdrTitle:'è²“è²“<span>å»æ‰€</span>ç›£å¯Ÿ',
    soTitle:'è²“è²“å»æ‰€ç›£å¯Ÿç«™',soDesc:'è«‹å…ˆåˆ°ã€Œè¨­å®šã€å¡«å¯« Claude API Key<br>åŠè²“è²“è³‡æ–™ï¼Œå†å•Ÿå‹•ç›£å¯Ÿ',
    soGo:'å‰å¾€è¨­å®š â†’',soSkip:'æˆ‘å·²è¨­å®šå¥½',
    tabMonitor:'ğŸ“· ç›£å¯Ÿ',tabLog:'ğŸ“‹ è¨˜éŒ„',tabStats:'ğŸ“Š åˆ†æ',tabSettings:'âš™ï¸ è¨­å®š',
    camStandby:'å¾…æ©Ÿä¸­',camNotStarted:'æœªå•Ÿå‹•',roiHint:'å•Ÿå‹•å¾Œé•·æŒ‰æ‹–æ›³è¨­å®šè²“ç ‚ç›¤ç¯„åœ',
    startBtn:'ğŸ¥ å•Ÿå‹•ç›£å¯Ÿ',stopBtn:'â¹ åœæ­¢',
    motionLabel:'å‹•æ…‹åµæ¸¬',sessionActiveLabel:'é€²è¡Œä¸­',
    startTimeLabel:'é–‹å§‹æ™‚é–“',durationLabel:'æŒçºŒæ™‚é–“',activityLabel:'æ´»å‹•åˆ¤æ–·',confidenceLabel:'ä¿¡å¿ƒåº¦',
    recentTitle:'æœ€è¿‘è¨˜éŒ„',noRecordsMsg:'å°šç„¡è¨˜éŒ„',logEmptyMsg:'è¨˜éŒ„æœƒåœ¨è²“è²“ä½¿ç”¨å»æ‰€å¾Œå‡ºç¾',
    statsEmptyMsg:'æ”¶é›†åˆ°è¨˜éŒ„å¾Œæœƒé¡¯ç¤ºçµ±è¨ˆ',clearLogsBtn:'æ¸…é™¤æ‰€æœ‰è¨˜éŒ„',
    sectionAPI:'ğŸ”‘ API è¨­å®š',apiKeyLabel:'Claude API Key',modelLabel:'Claude æ¨¡å‹',
    modelHaikuOpt:'claude-haiku-3-5ï¼ˆ~$0.40/é€±ï¼Œæ¨è–¦ï¼‰',modelSonnetOpt:'claude-sonnet-4-5ï¼ˆ~$1.50/é€±ï¼Œæ›´æº–ï¼‰',
    sectionCats:'ğŸ± è²“è²“è­˜åˆ¥è³‡æ–™',
    idTip:'<strong>è­˜åˆ¥æº–ç¢ºåº¦ï¼š</strong>ä¸Šè¼‰æ¸…æ™°åƒè€ƒç›¸ + å¡«å¯«å“ç¨® + æè¿°ç¨ç‰¹ç‰¹å¾µ<br>è‹¥çœŸä¿‚åˆ†å””æ¸…ï¼Œæœƒè¨˜ç‚ºã€ŒæœªçŸ¥ã€ï¼Œå””æœƒäº‚ä¼°',
    addCatBtn:'ï¼‹ æ–°å¢è²“è²“',catNamePH:'è²“è²“åå­—',breedPH:'é¸æ“‡å“ç¨®',
    descPH:'ç¨ç‰¹ç‰¹å¾µï¼šèŠ±ç´‹ä½ç½®ã€é«”å‹å¤§ç´°ã€è€³å‹ã€é¢éƒ¨æ¨™è¨˜ç­‰\nä¾‹å¦‚ï¼šå³è€³åº•æœ‰ä¸€ç²’é»‘ç—£ï¼Œé«”å‹è¼ƒå¤§',
    photoLabel:'åƒè€ƒç›¸',colorLabel:'é¡è‰²æ¨™è¨˜',deleteCat:'åˆªé™¤',
    sectionNotif:'ğŸ”” é€šçŸ¥è¨­å®š',tgChatLabel:'Telegram Chat ID',
    testDiscordBtn:'æ¸¬è©¦ Discord',testTelegramBtn:'æ¸¬è©¦ Telegram',
    sectionDetect:'âš™ï¸ åµæ¸¬è¨­å®š',
    sensitivityLabel:'å‹•æ…‹æ•æ„Ÿåº¦ï¼ˆæ•¸å€¼è¶Šä½è¶Šæ•æ„Ÿï¼‰',
    verySensitive:'æ¥µæ•æ„Ÿ',normalSens:'ä¸€èˆ¬',lowSensitive:'ä½æ•æ„Ÿ',
    triggerLabel:'æŒçºŒéƒå‹•å¤šå°‘ç§’å¾Œé–‹å§‹ Sessionï¼ˆç§’ï¼‰',
    triggerHint:'é¿å…çŸ­æš«éƒå‹•èª¤è§¸ç™¼ï¼Œå»ºè­° 3 ç§’',
    sessionEndLabel:'éœæ­¢å¤šå°‘ç§’å¾ŒçµæŸ Sessionï¼ˆç§’ï¼‰',
    sessionEndHint:'è²“è²“é›¢é–‹ç ‚ç›¤å¾Œï¼Œç­‰å¤šå°‘ç§’å…ˆå„²å­˜å‘¢æ¬¡å¦‚å»è¨˜éŒ„ã€‚å»ºè­° 45 ç§’ï¼Œå› ç‚ºè²“å’ªæ©æ²™æ™‚æœƒçŸ­æš«åœæ­¢éƒå‹•ï¼Œå””æƒ³èª¤ä»¥ç‚ºä½¢å·²é›¢é–‹',
    sectionHealth:'ğŸ¥ å¥åº·è­¦å‘Šè¨­å®š',
    alertNoVisitLabel:'å¤šå°‘å°æ™‚ç„¡è¨˜éŒ„ç™¼è­¦å‘Šï¼ˆ0 = åœç”¨ï¼‰',
    alertMaxDailyLabel:'æ¯æ—¥å¦‚å»æ¬¡æ•¸ä¸Šé™ï¼ˆè¶…éç™¼è­¦å‘Šï¼‰',
    alertMaxDurLabel:'å–®æ¬¡å¦‚å»æœ€é•·æ™‚é–“è­¦å‘Šï¼ˆåˆ†é˜ï¼‰',
    saveBtn:'ğŸ’¾ å„²å­˜è¨­å®š',exportBtn:'ğŸ“¤ åŒ¯å‡ºè¨˜éŒ„ (JSON)',
    filterAll:'å…¨éƒ¨',filterPee:'å°¿å°¿',filterPoop:'å¤§ä¾¿',filterAlert:'âš ï¸ è­¦å‘Š',
    todayCount:'ä»Šæ—¥æ¬¡æ•¸',weekPee:'æœ¬é€±å°¿',weekPoop:'æœ¬é€±ä¾¿',
    weekTotal:'æœ¬é€±ç¸½è¨˜éŒ„',allTotal:'å…¨éƒ¨è¨˜éŒ„',lastVisit:'ä¸Šæ¬¡ï¼š',noLog:'ç„¡è¨˜éŒ„',
    healthAlerts:'å¥åº·è­¦å‘Š',todayTimeline:'ä»Šæ—¥æ™‚é–“è»¸',peeLabel:'â–  å°¿å°¿',poopLabel:'â–  å¤§ä¾¿',
    settingsSaved:'âœ… è¨­å®šå·²å„²å­˜',catNameRequired:'è«‹å¡«å¯«è²“è²“åå­—',unknownCat:'æœªçŸ¥',
    analyzing:'ğŸ”µ åˆ†æä¸­...',inSession:'ğŸ”´ é€²è¡Œä¸­',monitoring:'ğŸ“· ç›£å¯Ÿä¸­',
    actPee:'ğŸ’§ å°¿å°¿',actPoop:'ğŸ’© å¤§ä¾¿',actInvestigate:'ğŸ‘€ æ¢ç´¢',actCover:'â› æ©æ²™',actExit:'ğŸšª é›¢é–‹',actNone:'â€”',actUnknown:'â“ åˆ†å””æ¸…',
    warnLabel:'âš ï¸ æ³¨æ„',alertLabel:'ğŸš¨ è­¦å‘Š',
    logsCleared:'è¨˜éŒ„å·²æ¸…é™¤',logsClearConfirm:'ç¢ºå®šæ¸…é™¤æ‰€æœ‰è¨˜éŒ„ï¼Ÿ',
    discordOK:'âœ… Discord æ¸¬è©¦æˆåŠŸ',discordFail:'âŒ Discord æ¸¬è©¦å¤±æ•—',
    tgOK:'âœ… Telegram æ¸¬è©¦æˆåŠŸ',tgFail:'âŒ Telegram éŒ¯èª¤',
    tgFillAll:'è«‹å¡«å¯« Telegram Token åŒ Chat ID',discordFillAll:'è«‹å…ˆå¡«å¯« Discord Webhook URL',
    apiKeyRequired:'âŒ è«‹å…ˆå¡«å¯« Claude API Key',camError:'âŒ ç„¡æ³•å­˜å–é¡é ­',
    apiErr401:'âŒ API Key éŒ¯èª¤ï¼Œè«‹åˆ°è¨­å®šæ›´æ­£',
    apiErr429:'âš ï¸ API è«‹æ±‚éå¤šï¼Œè«‹ç¨å¾Œå†è©¦',
    apiErrGeneric:'âŒ Claude API éŒ¯èª¤',
    apiErrNetwork:'âŒ ç¶²çµ¡éŒ¯èª¤ï¼Œç„¡æ³•é€£æ¥ Claude API',
    photoSaved:'åƒè€ƒç›¸å·²å„²å­˜',photoTooLarge:'âŒ ç›¸ç‰‡å¤ªå¤§ï¼Œè«‹é¸ç´°ä¸€å•²',
    catAdded:'å·²æ–°å¢è²“è²“',catDeleted:'å·²åˆªé™¤',
    sessionFor:'å¦‚å»ç´€éŒ„',avgPerSession:'å¹³å‡æ¯æ¬¡',weekVisits:'æœ¬é€±å¦‚å»',
    ds:'ç§’',dm:'åˆ†',secAgo:'ç§’å‰',minAgo:'åˆ†å‰',hrAgo:'å°æ™‚å‰',dayAgo:'æ—¥å‰',
    minCatError:'æœ€å°‘ä¿ç•™ä¸€éš»è²“è²“',deleteConfirm:'åˆªé™¤',
    identBasisPfx:'ğŸ”',
    hrAgoSuffix:' å°æ™‚æœªæœ‰å¦‚å»è¨˜éŒ„',timesToday:' æ¬¡ï¼Œæ¬¡æ•¸åå¤š',tooLong:'ï¼Œæ™‚é–“éé•·',
    noPoopSuffix:'è¶…é 48 å°æ™‚æœªæœ‰å¤§ä¾¿è¨˜éŒ„',
    // Waste analysis display
    wasteAnalysis:'ğŸ”¬ å»¢ç‰©åˆ†æ',wasteNotVisible:'å½±å””åˆ°å»¢ç‰©ï¼ˆå·²æ©æ²™æˆ–è§’åº¦å•é¡Œï¼‰',
    urineClump:'å°¿åœ˜',urineColor:'å°¿æ¶²é¡è‰²',fecesSect:'ç³ä¾¿',fecesColor:'é¡è‰²',fecesConsist:'å½¢æ…‹',
    straining:'è§€å¯Ÿåˆ°ç”¨åŠ›/æ™æ‰',
    // Urine clump sizes
    uSmall:'åç´°ï¼ˆå¯èƒ½é£²æ°´ä¸è¶³ï¼‰',uNormal:'æ­£å¸¸',uLarge:'åå¤§ï¼ˆé£²æ°´é‡é«˜ï¼‰',
    // Urine colors
    ucNormal:'æ·¡é»ƒè‰²ï¼ˆæ­£å¸¸ï¼‰',ucDark:'æ·±é»ƒè‰²ï¼ˆæ¿ƒç¸®ï¼Œå»ºè­°å¤šé£²æ°´ï¼‰',ucOrange:'æ©™è‰²ï¼ˆéœ€ç•™æ„ï¼‰',ucBlood:'è¦‹è¡€ï¼ˆâš ï¸ ç«‹å³æ±‚é†«ï¼‰',
    // Feces colors
    fcNormal:'æ£•è‰²ï¼ˆæ­£å¸¸ï¼‰',fcBlack:'é»‘è‰²ï¼ˆå¯èƒ½æ¶ˆåŒ–é“å‡ºè¡€ï¼‰',fcPale:'ç°ç™½è‰²ï¼ˆè‚è‡Ÿ/è†½é“å•é¡Œï¼‰',fcRed:'å¸¶ç´…è‰²ï¼ˆä¸‹æ¶ˆåŒ–é“å‡ºè¡€ï¼‰',
    // Feces consistency
    fsNormal:'æ­£å¸¸æˆå½¢',fsSoft:'åè»Ÿ/æ•£',fsHard:'åç¡¬/ç´°ç²’',fsDiarrhea:'è…¹ç€‰ï¼ˆâš ï¸ éœ€é—œæ³¨ï¼‰',
    // Waste health flags in notifications
    wfBloodUrine:'å°¿æ¶²å¸¶è¡€',wfDarkUrine:'å°¿æ¶²æ·±è‰²ï¼ˆæ¿ƒç¸®ï¼‰',wfSmallClump:'å°¿åœ˜åç´°',
    wfBloodFeces:'ç³ä¾¿å¸¶è¡€',wfBlackFeces:'ç³ä¾¿å‘ˆé»‘è‰²',wfDiarrhea:'è…¹ç€‰',wfStraining:'å¦‚å»æ™‚æ˜é¡¯ç”¨åŠ›',
    checkingPresence:'ğŸ” ç¢ºèªé›¢å ´ä¸­...',catStillPresent:'è²“è²“ä»²ä¿‚åº¦ï¼Œç¹¼çºŒç›£å¯Ÿ',
    sectionNotifMode:'ğŸ“¬ é€šçŸ¥æ¨¡å¼',notifModeLabel:'ç™¼é€é€šçŸ¥æ™‚æ©Ÿ',
    notifAll:'æ¯æ¬¡å¦‚å»éƒ½ç™¼',notifAlertsOnly:'åªç™¼å¥åº·è­¦å‘Š',notifDaily:'æ¯æ—¥æ‘˜è¦ï¼ˆæ—©ä¸Š 8 æ™‚ï¼‰',
    noEliminationLabel:'ç•°å¸¸æ¢è¨ªè­¦å‘Šï¼šè²“å’ªåœç•™å¤šå°‘ç§’ä½†å†‡æ’æ³„ï¼ˆ0 = åœç”¨ï¼‰',
    noEliminationHint:'å»ºè­° 90 ç§’ã€‚è²“å…¥ç ‚ç›†å»å†‡å°¿å†‡ä¾¿å¯èƒ½ä¿‚å°¿é“é˜»å¡ç­‰ç·Šæ€¥æƒ…æ³',
    noEliminationAlert:'âš ï¸ å…¥ç ‚ç›†ä½†å†‡æ’æ³„',
    dailySummaryTitle:'ğŸ“Š æ¯æ—¥å¦‚å»æ‘˜è¦',visitCount:'å¦‚å»æ¬¡æ•¸',peeCount:'å°¿',poopCount:'ä¾¿'
  },
  en: {
    appTitle:'Cat Litter Monitor',hdrTitle:'Cat <span>Litter</span> Monitor',
    soTitle:'Cat Litter Monitor',soDesc:'Please go to Settings, enter your Claude API Key and cat profiles first',
    soGo:'Go to Settings â†’',soSkip:"I'm all set",
    tabMonitor:'ğŸ“· Monitor',tabLog:'ğŸ“‹ Log',tabStats:'ğŸ“Š Stats',tabSettings:'âš™ï¸ Settings',
    camStandby:'Standby',camNotStarted:'Not started',roiHint:'After start, drag to set litter box zone',
    startBtn:'ğŸ¥ Start Monitor',stopBtn:'â¹ Stop',
    motionLabel:'Motion',sessionActiveLabel:'Active',
    startTimeLabel:'Start',durationLabel:'Duration',activityLabel:'Activity',confidenceLabel:'Confidence',
    recentTitle:'Recent',noRecordsMsg:'No records yet',logEmptyMsg:'Records appear after litter box visits',
    statsEmptyMsg:'Stats appear once records are collected',clearLogsBtn:'Clear All Logs',
    sectionAPI:'ğŸ”‘ API Settings',apiKeyLabel:'Claude API Key',modelLabel:'Claude Model',
    modelHaikuOpt:'claude-haiku-3-5 (~$0.40/week, recommended)',modelSonnetOpt:'claude-sonnet-4-5 (~$1.50/week, more accurate)',
    sectionCats:'ğŸ± Cat Profiles',
    idTip:'<strong>Identification accuracy:</strong> Upload a clear reference photo + select breed + describe unique features.<br>If unsure, records as "unknown" â€” never guesses.',
    addCatBtn:'ï¼‹ Add Cat',catNamePH:"Cat's name",breedPH:'Select breed',
    descPH:'Unique features: markings, size, ear shape, facial marks...\ne.g. Black spot under right ear, larger build',
    photoLabel:'Photo',colorLabel:'Colour tag',deleteCat:'Delete',
    sectionNotif:'ğŸ”” Notifications',tgChatLabel:'Telegram Chat ID',
    testDiscordBtn:'Test Discord',testTelegramBtn:'Test Telegram',
    sectionDetect:'âš™ï¸ Detection Settings',
    sensitivityLabel:'Motion sensitivity (lower = more sensitive)',
    verySensitive:'Very sensitive',normalSens:'Normal',lowSensitive:'Low',
    triggerLabel:'Seconds of motion to trigger session',
    triggerHint:'Prevents false triggers. 3 seconds recommended.',
    sessionEndLabel:'Seconds of stillness to end session',
    sessionEndHint:'How long to wait after the cat leaves before saving the record. 45s recommended â€” cats pause while covering litter.',
    sectionHealth:'ğŸ¥ Health Alert Settings',
    alertNoVisitLabel:'Hours without visit before alert (0 = off)',
    alertMaxDailyLabel:'Max daily visits before alert',
    alertMaxDurLabel:'Max session duration alert (minutes)',
    saveBtn:'ğŸ’¾ Save Settings',exportBtn:'ğŸ“¤ Export Logs (JSON)',
    filterAll:'All',filterPee:'Pee',filterPoop:'Poop',filterAlert:'âš ï¸ Alerts',
    todayCount:"Today",weekPee:'Pee /wk',weekPoop:'Poop /wk',
    weekTotal:'This Week',allTotal:'All Records',lastVisit:'Last: ',noLog:'No records',
    healthAlerts:'Health Alerts',todayTimeline:"Today's Timeline",peeLabel:'â–  Pee',poopLabel:'â–  Poop',
    settingsSaved:'âœ… Settings saved',catNameRequired:"Please enter the cat's name",unknownCat:'Unknown',
    analyzing:'ğŸ”µ Analyzing...',inSession:'ğŸ”´ Active',monitoring:'ğŸ“· Monitoring',
    actPee:'ğŸ’§ Urinating',actPoop:'ğŸ’© Defecating',actInvestigate:'ğŸ‘€ Investigating',actCover:'â› Covering',actExit:'ğŸšª Exiting',actNone:'â€”',actUnknown:'â“ Unclear',
    warnLabel:'âš ï¸ Warning',alertLabel:'ğŸš¨ Alert',
    logsCleared:'Logs cleared',logsClearConfirm:'Clear all logs?',
    discordOK:'âœ… Discord test OK',discordFail:'âŒ Discord test failed',
    tgOK:'âœ… Telegram test OK',tgFail:'âŒ Telegram error',
    tgFillAll:'Please fill Telegram Token and Chat ID',discordFillAll:'Please fill Discord Webhook URL first',
    apiKeyRequired:'âŒ Please add Claude API Key in Settings',camError:'âŒ Cannot access camera',
    apiErr401:'âŒ Invalid API Key â€” please check Settings',
    apiErr429:'âš ï¸ API rate limit reached, please wait',
    apiErrGeneric:'âŒ Claude API error',
    apiErrNetwork:'âŒ Network error â€” cannot reach Claude API',
    photoSaved:'Reference photo saved',photoTooLarge:'âŒ Photo too large, choose a smaller one',
    catAdded:'Cat added',catDeleted:'Deleted',
    sessionFor:'Litter box visit',avgPerSession:'Avg per visit',weekVisits:'Visits /wk',
    ds:'s',dm:'m',secAgo:'s ago',minAgo:'m ago',hrAgo:'h ago',dayAgo:'d ago',
    minCatError:'At least one cat required',deleteConfirm:'Delete',
    identBasisPfx:'ğŸ”',
    hrAgoSuffix:' hours without a visit',timesToday:' visits today (high)',tooLong:' â€” unusually long',
    noPoopSuffix:'No defecation record for 48+ hours',
    // Waste analysis display
    wasteAnalysis:'ğŸ”¬ Waste Analysis',wasteNotVisible:'Waste not visible (covered or angle)',
    urineClump:'Urine clump',urineColor:'Urine colour',fecesSect:'Feces',fecesColor:'Colour',fecesConsist:'Consistency',
    straining:'Straining observed',
    // Urine clump sizes
    uSmall:'Small (possible low water intake)',uNormal:'Normal',uLarge:'Large (high water intake)',
    // Urine colors
    ucNormal:'Pale yellow (normal)',ucDark:'Dark yellow (concentrated â€” drink more water)',ucOrange:'Orange (monitor)',ucBlood:'Blood present (âš ï¸ see vet immediately)',
    // Feces colors
    fcNormal:'Brown (normal)',fcBlack:'Black (possible GI bleed)',fcPale:'Pale/grey (liver or bile duct issue)',fcRed:'Red-tinged (lower GI bleed)',
    // Feces consistency
    fsNormal:'Normal formed',fsSoft:'Soft/loose',fsHard:'Hard/small pellets',fsDiarrhea:'Diarrhoea (âš ï¸ monitor closely)',
    // Waste health flags in notifications
    wfBloodUrine:'Blood in urine',wfDarkUrine:'Dark concentrated urine',wfSmallClump:'Small urine clump',
    wfBloodFeces:'Blood in feces',wfBlackFeces:'Black feces',wfDiarrhea:'Diarrhoea',wfStraining:'Visible straining',
    checkingPresence:'ğŸ” Confirming departure...',catStillPresent:'Cat still present, continuing',
    sectionNotifMode:'ğŸ“¬ Notification Mode',notifModeLabel:'When to send notifications',
    notifAll:'Every visit',notifAlertsOnly:'Health alerts only',notifDaily:'Daily summary (8 AM)',
    noEliminationLabel:'No-elimination alert: seconds in box without output (0 = off)',
    noEliminationHint:'Recommended 90s. Cat in box with no output may indicate urinary blockage or obstruction.',
    noEliminationAlert:'âš ï¸ In box but no elimination',
    dailySummaryTitle:'ğŸ“Š Daily Litter Summary',visitCount:'Visits',peeCount:'Pee',poopCount:'Poop'
  }
};

let lang = localStorage.getItem('catmon_lang') || 'zh';
const t = k => STRINGS[lang][k] || STRINGS.zh[k] || k;

function applyLang() {
  // Elements whose IDs match STRINGS keys exactly
  const ids = Object.keys(STRINGS.zh).filter(k => document.getElementById(k));
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    if (id==='hdrTitle') el.innerHTML = t('hdrTitle');
    else if (id==='idTip') el.innerHTML = t('idTip');
    else el.textContent = t(id);
  });
  // Elements with hyphenated IDs that don't match STRINGS keys
  const hyphenMap = {
    'so-title':'soTitle', 'so-desc':'soDesc', 'so-go':'soGo', 'so-skip':'soSkip',
    'hdr-title':'hdrTitle'
  };
  Object.entries(hyphenMap).forEach(([id,key])=>{
    const el=document.getElementById(id);
    if(!el)return;
    if(key==='hdrTitle')el.innerHTML=t(key);
    else el.textContent=t(key);
  });
  document.getElementById('langBtn').textContent = lang==='zh'?'EN':'ä¸­';
  document.title = 'ğŸ± ' + t('appTitle');
  // Translate select options
  const optMap={notifAllOpt:'notifAll',notifAlertsOpt:'notifAlertsOnly',notifDailyOpt:'notifDaily'};
  Object.entries(optMap).forEach(([id,key])=>{const el=document.getElementById(id);if(el)el.textContent=t(key);});
  renderCatCards();
  renderLogFilter();
}

function toggleLang() {
  lang = lang==='zh'?'en':'zh';
  localStorage.setItem('catmon_lang', lang);
  applyLang();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAT DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_COLORS = ['#ff9800','#9c27b0','#2196f3','#4caf50','#e91e63','#00bcd4','#ff5722'];

function getCats() {
  const s = localStorage.getItem('catmon_cats');
  if (s) return JSON.parse(s);
  return [
    {id:'cat_1',name:'',breed:'',desc:'',colorDot:'#ff9800'},
    {id:'cat_2',name:'',breed:'',desc:'',colorDot:'#9c27b0'}
  ];
}
function saveCats(cats){ localStorage.setItem('catmon_cats',JSON.stringify(cats)); }
function getCatById(id){ return getCats().find(c=>c.id===id); }
function getCatName(id){ const c=getCatById(id); return c?(c.name||t('unknownCat')):t('unknownCat'); }
function getCatColor(id){ const c=getCatById(id); return c?c.colorDot:'#5a7a96'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAT CARD UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCatCards() {
  const cats = getCats();
  document.getElementById('catCards').innerHTML = cats.map((cat,i)=>buildCatCard(cat,i)).join('');
}

function breedOptions(sel) {
  return BREEDS[lang].map((b,i)=>`<option value="${BREEDS.zh[i]}" ${BREEDS.zh[i]===sel?'selected':''}>${b}</option>`).join('');
}

function buildCatCard(cat, idx) {
  const photo = localStorage.getItem(`catmon_photo_${cat.id}`);
  const thumbImg = photo ? `<img src="${photo}" alt="">` : `<span class="pi">ğŸ“·</span><span class="pl">${t('photoLabel')}</span>`;
  return `<div class="cat-card" id="card_${cat.id}">
    <div class="cat-card-header" onclick="toggleCatCard('${cat.id}')">
      <div class="cat-dot" style="background:${cat.colorDot};width:12px;height:12px;border-radius:50%"></div>
      <div class="cat-name-display">${cat.name||'('+t('catNamePH')+')'}</div>
      <div class="cat-breed-display">${cat.breed&&cat.breed!==BREEDS.zh[0]?cat.breed.split(' ')[0]:''}</div>
      <span class="cat-card-chevron">â–¼</span>
    </div>
    <div class="cat-card-body">
      <div class="photo-row">
        <div class="photo-thumb" id="thumb_${cat.id}">
          ${thumbImg}
          <input type="file" accept="image/*" onchange="handlePhotoUpload('${cat.id}',this)">
        </div>
        <div class="cat-fields">
          <input type="text" placeholder="${t('catNamePH')}" value="${cat.name}" oninput="updateCatField('${cat.id}','name',this.value)">
          <select onchange="updateCatField('${cat.id}','breed',this.value)">${breedOptions(cat.breed)}</select>
          <textarea rows="2" placeholder="${t('descPH')}" oninput="updateCatField('${cat.id}','desc',this.value)">${cat.desc}</textarea>
        </div>
      </div>
      <div class="cat-footer">
        <label style="font-size:10px;color:var(--text-dim)">${t('colorLabel')}</label>
        <input type="color" value="${cat.colorDot}" style="width:34px;height:28px;border:1px solid var(--border);border-radius:6px;background:none;cursor:pointer;padding:2px"
          oninput="updateCatField('${cat.id}','colorDot',this.value);document.querySelector('#card_${cat.id} .cat-card-header .cat-dot').style.background=this.value">
        <button class="cat-delete-btn" onclick="deleteCat('${cat.id}')">${t('deleteCat')}</button>
      </div>
    </div>
  </div>`;
}

function toggleCatCard(id){ document.getElementById('card_'+id).classList.toggle('open'); }

function updateCatField(id,field,value){
  const cats=getCats(), cat=cats.find(c=>c.id===id);
  if (!cat) return;
  cat[field]=value; saveCats(cats);
  const card=document.getElementById('card_'+id);
  if (card){
    card.querySelector('.cat-name-display').textContent=cat.name||'('+t('catNamePH')+')';
    const bd=card.querySelector('.cat-breed-display');
    bd.textContent=cat.breed&&cat.breed!==BREEDS.zh[0]?cat.breed.split(' ')[0]:'';
  }
}

function addCat(){
  const cats=getCats(), newId='cat_'+Date.now();
  const color=DEFAULT_COLORS[cats.length%DEFAULT_COLORS.length];
  cats.push({id:newId,name:'',breed:'',desc:'',colorDot:color});
  saveCats(cats); renderCatCards();
  setTimeout(()=>{const c=document.getElementById('card_'+newId);if(c){c.classList.add('open');c.scrollIntoView({behavior:'smooth'});}},50);
  toast(t('catAdded'),'success'); renderLogFilter();
}

function deleteCat(id){
  const cats=getCats();
  if (cats.length<=1){toast(t('minCatError'),'error');return;}
  const name=getCatName(id);
  if (!confirm(t('deleteConfirm')+' '+name+'ï¼Ÿ'))return;
  saveCats(cats.filter(c=>c.id!==id));
  localStorage.removeItem('catmon_photo_'+id);
  renderCatCards(); renderLogFilter();
  toast(name+' '+t('catDeleted'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHOTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handlePhotoUpload(catId,input){
  const file=input.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    const img=new Image();
    img.onload=()=>{
      const MAX=512,scale=Math.min(1,MAX/Math.max(img.width,img.height));
      const canvas=document.createElement('canvas');
      canvas.width=img.width*scale; canvas.height=img.height*scale;
      canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
      const b64=canvas.toDataURL('image/jpeg',.75);
      try{
        localStorage.setItem('catmon_photo_'+catId,b64);
        const th=document.getElementById('thumb_'+catId);
        if(th){
          th.querySelectorAll('.pi,.pl').forEach(e=>e.style.display='none');
          const ex=th.querySelector('img');if(ex)ex.remove();
          const el=document.createElement('img');el.src=b64;th.appendChild(el);
        }
        toast(t('photoSaved'),'success');
      }catch(e){toast(t('photoTooLarge'),'error');}
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}

function getRefPhoto(catId){
  const s=localStorage.getItem('catmon_photo_'+catId);
  return s?s.split(',')[1]:null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SETTING_KEYS=['apiKey','apiModel','notifMode','noEliminationSecs','discordWebhook','tgToken','tgChatId','sensitivity','triggerDelay','sessionEndDelay','alertNoVisit','alertMaxDaily','alertMaxDuration'];

function loadSettings(){
  return {apiKey:'',apiModel:'claude-haiku-3-5-20251001',notifMode:'all',noEliminationSecs:90,discordWebhook:'',tgToken:'',tgChatId:'',sensitivity:15,triggerDelay:3,sessionEndDelay:45,alertNoVisit:24,alertMaxDaily:8,alertMaxDuration:15,...JSON.parse(localStorage.getItem('catmon_settings')||'{}')};
}
function saveSettings(){
  const s={};
  SETTING_KEYS.forEach(k=>{const el=document.getElementById(k);if(el)s[k]=(el.type==='number'||el.type==='range')?+el.value:el.value;});
  localStorage.setItem('catmon_settings',JSON.stringify(s));
  toast(t('settingsSaved'),'success');
}
function loadSettingsToForm(){
  const s=loadSettings();
  SETTING_KEYS.forEach(k=>{const el=document.getElementById(k);if(el)el.value=s[k];});
  document.getElementById('sensitivityVal').textContent=s.sensitivity+'%';
}
function v(id){return document.getElementById(id)?.value||'';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getLogs(){return JSON.parse(localStorage.getItem('catmon_logs')||'[]');}
function saveLogs(logs){localStorage.setItem('catmon_logs',JSON.stringify(logs.slice(0,500)));}
function addLog(entry){const logs=getLogs();logs.unshift({...entry,id:Date.now()});saveLogs(logs);renderRecentEvents();renderLog();renderStats();}
function clearAllLogs(){if(!confirm(t('logsClearConfirm')))return;localStorage.removeItem('catmon_logs');renderRecentEvents();renderLog();renderStats();toast(t('logsCleared'));}
function exportLogs(){const blob=new Blob([JSON.stringify(getLogs(),null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`catmon_${new Date().toISOString().slice(0,10)}.json`;a.click();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAMERA & MOTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let stream=null,motionTimer=null,sessionEndTimer=null,sessionTimerInterval=null;
let isInSession=false,motionStartTime=null,wakeLock=null;
let sessionStartTime=null,sessionApiCalls=[],lastAnalyzeTime=0;
let prevFrame=null,motionCanvas=null,motionCtx=null;
let roi=null,isDrawingROI=false,roiStart=null;
// Smart capture â€” 3 shots per session:
// [1] Entry shot: 3s after session starts (cat just stepped in, most visible)
// [2] Drop shot: motion drops sharply â†’ cat likely squatting to eliminate
// [3] Final shot: just before session ends (captures covering behaviour)
let entryFrameDone=false;   // shot 1 fired?
let dropFrameDone=false;    // shot 2 fired?
let sessionPeakPct=0;       // rolling peak within current active burst
let recentPcts=[];          // last N readings for smoothing
const DROP_THRESHOLD=22;    // pct-point drop to signal squat
const SMOOTH_N=4;           // smooth over 4 ticks = 2 seconds

async function startCamera(){
  const s=loadSettings();
  if(!s.apiKey){toast(t('apiKeyRequired'),'error');switchTab('settings');return;}
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}},audio:false});
    const video=document.getElementById('videoEl');video.srcObject=stream;await video.play();
    document.getElementById('btnStart').disabled=true;
    document.getElementById('btnStop').disabled=false;
    setStatusDot('active');setOverlay(t('monitoring'));
    setupROICanvas();startMotionDetection();acquireWakeLock();
    if(!roi){roi={x:.2,y:.2,w:.6,h:.6};drawROI();}
  }catch(e){toast(t('camError')+': '+e.message,'error');}
}

function stopCamera(){
  if(stream){stream.getTracks().forEach(tr=>tr.stop());stream=null;}
  if(motionTimer){clearInterval(motionTimer);motionTimer=null;}
  if(wakeLock){wakeLock.release();wakeLock=null;}
  document.getElementById('btnStart').disabled=false;
  document.getElementById('btnStop').disabled=true;
  setStatusDot('');setOverlay(t('camStandby'));setCamStatus(t('camNotStarted'),'');
  if(isInSession)endSession(true);prevFrame=null;
}

async function acquireWakeLock(){try{if('wakeLock'in navigator)wakeLock=await navigator.wakeLock.request('screen');}catch(e){}}

function startMotionDetection(){
  motionCanvas=document.createElement('canvas');motionCanvas.width=160;motionCanvas.height=120;
  motionCtx=motionCanvas.getContext('2d',{willReadFrequently:true});prevFrame=null;
  motionTimer=setInterval(detectMotion,500);
}

function detectMotion(){
  const video=document.getElementById('videoEl');if(!video.videoWidth)return;
  const W=motionCanvas.width,H=motionCanvas.height;
  motionCtx.drawImage(video,0,0,W,H);
  const frame=motionCtx.getImageData(0,0,W,H);
  if(!prevFrame){prevFrame=frame;return;}
  const s=loadSettings();
  let rx=0,ry=0,rw=W,rh=H;
  if(roi){rx=Math.floor(roi.x*W);ry=Math.floor(roi.y*H);rw=Math.floor(roi.w*W);rh=Math.floor(roi.h*H);}
  let diff=0,count=0;
  for(let y=ry;y<ry+rh;y++)for(let x=rx;x<rx+rw;x++){
    const i=(y*W+x)*4;
    diff+=(Math.abs(frame.data[i]-prevFrame.data[i])+Math.abs(frame.data[i+1]-prevFrame.data[i+1])+Math.abs(frame.data[i+2]-prevFrame.data[i+2]))/3;
    count++;
  }
  const pct=count>0?Math.min(100,Math.round(diff/count/2.55)):0;
  prevFrame=frame;
  // Smooth pct over last SMOOTH_N readings
  recentPcts.push(pct);if(recentPcts.length>SMOOTH_N)recentPcts.shift();
  const smoothed=Math.round(recentPcts.reduce((a,b)=>a+b,0)/recentPcts.length);
  updateMotionMeter(smoothed);
  handleMotionState(smoothed,s.sensitivity,s);
}

function handleMotionState(smoothedPct,threshold,s){
  const now=Date.now();
  const hasMotion=smoothedPct>=threshold;

  if(hasMotion){
    setStatusDot('motion');
    if(!motionStartTime)motionStartTime=now;
    if(sessionEndTimer){clearTimeout(sessionEndTimer);sessionEndTimer=null;}

    // Trigger session once motion sustained >= triggerDelay
    const elapsed=(now-motionStartTime)/1000;
    if(elapsed>=s.triggerDelay&&!isInSession)startSession();

    // Track peak pct for drop detection
    if(isInSession)sessionPeakPct=Math.max(sessionPeakPct,smoothedPct);

  }else{
    setStatusDot(stream?'active':'');
    if(isInSession&&!sessionEndTimer)
      sessionEndTimer=setTimeout(()=>schedulePresenceCheck(s),s.sessionEndDelay*1000);
    if(!isInSession)motionStartTime=null;
  }

  if(!isInSession)return;

  // â”€â”€ SHOT 1: Entry frame, 3s after session starts â”€â”€
  if(!entryFrameDone&&(now-sessionStartTime.getTime())>=3000){
    analyzeFrame('entry');entryFrameDone=true;lastAnalyzeTime=now;
  }

  // â”€â”€ SHOT 2: Drop frame â€” motion fell sharply from peak (squat moment) â”€â”€
  // Conditions: entry done, drop not yet fired, peak was meaningfully high,
  // and current smoothed is well below that peak
  if(entryFrameDone&&!dropFrameDone&&sessionPeakPct>=(threshold+10)){
    const drop=sessionPeakPct-smoothedPct;
    if(drop>=DROP_THRESHOLD&&(now-lastAnalyzeTime)>4000){
      analyzeFrame('drop');dropFrameDone=true;lastAnalyzeTime=now;
      sessionPeakPct=0; // reset so we can detect a second burst if cat investigates more
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startSession(){
  isInSession=true;sessionStartTime=new Date();sessionApiCalls=[];lastAnalyzeTime=0;
  entryFrameDone=false;dropFrameDone=false;sessionPeakPct=0;recentPcts=[];
  document.getElementById('sessionCard').classList.add('visible');
  document.getElementById('sessionStart').textContent=formatTime(sessionStartTime);
  document.getElementById('sessionCatName').textContent='...';
  document.getElementById('sessionActivity').textContent='...';
  document.getElementById('sessionConf').textContent='â€”';
  sessionTimerInterval=setInterval(updateSessionDuration,1000);
  setCamStatus(t('inSession'),'in-session');setOverlay(t('inSession'));
  // Shot 1 fires automatically in handleMotionState after 3s
}

function updateSessionDuration(){
  if(!sessionStartTime)return;
  const sec=Math.round((Date.now()-sessionStartTime)/1000),m=Math.floor(sec/60),s2=sec%60;
  document.getElementById('sessionDur').textContent=m>0?`${m}${t('dm')} ${s2}${t('ds')}`:`${s2}${t('ds')}`;
}

// Called when stillness timer expires â€” ask Claude if cat is still present.
// Shot 3 (presence_check) serves dual purpose: confirm departure + waste analysis.
// If cat is still there â†’ reset timer and keep session alive.
// If cat is gone â†’ finalize.
async function schedulePresenceCheck(s){
  sessionEndTimer=null;
  setCamStatus(t('checkingPresence'),'analyzing');
  await analyzeFrame('presence_check');
  // Check the latest result
  const latest=sessionApiCalls[sessionApiCalls.length-1];
  if(latest&&latest.cat_present){
    // Cat still there â€” reset end timer
    setCamStatus(t('catStillPresent'),'in-session');
    setTimeout(()=>setCamStatus(t('inSession'),'in-session'),2000);
    sessionEndTimer=setTimeout(()=>schedulePresenceCheck(s),s.sessionEndDelay*1000);
  }else{
    // Cat gone â€” finalize
    finalizeSession();
  }
}

async function finalizeSession(){
  isInSession=false;
  if(sessionTimerInterval){clearInterval(sessionTimerInterval);sessionTimerInterval=null;}
  if(sessionEndTimer){clearTimeout(sessionEndTimer);sessionEndTimer=null;}
  motionStartTime=null;
  document.getElementById('sessionCard').classList.remove('visible');
  setCamStatus(t('monitoring'),'');setOverlay(t('monitoring'));
  if(!sessionApiCalls.length)return;
  const duration=Math.round((Date.now()-sessionStartTime)/1000);
  const result=aggregateSession(sessionApiCalls);
  if(!result.catPresent)return;
  const s=loadSettings();
  const entry={timestamp:sessionStartTime.toISOString(),endTimestamp:new Date().toISOString(),duration,cat:result.cat,catName:getCatName(result.cat),activity:result.activity,confidence:result.confidence,notes:result.notes,identBasis:result.identBasis,wasteAnalysis:result.wasteAnalysis,alerts:[]};
  entry.alerts=checkHealth(entry,s);
  addLog(entry);await sendNotifications(entry,s,entry.alerts);
}

async function endSession(aborted){
  // Called only on manual stop
  isInSession=false;
  if(sessionTimerInterval){clearInterval(sessionTimerInterval);sessionTimerInterval=null;}
  if(sessionEndTimer){clearTimeout(sessionEndTimer);sessionEndTimer=null;}
  motionStartTime=null;
  document.getElementById('sessionCard').classList.remove('visible');
  setCamStatus(t('monitoring'),'');setOverlay(t('monitoring'));
  if(!aborted&&sessionApiCalls.length)finalizeSession();
}

function aggregateSession(calls){
  if(!calls.length)return{catPresent:false};
  const catC={},actC={};let notes='',identBasis='',totalConf=0,valid=0,bestWaste=null;
  calls.forEach(c=>{
    if(!c||!c.cat_present)return;valid++;
    const cat=c.cat_identity||'unknown';catC[cat]=(catC[cat]||0)+1;
    const act=c.activity||'none';actC[act]=(actC[act]||0)+1;
    if(c.health_notes)notes=c.health_notes;
    if(c.identification_basis)identBasis=c.identification_basis;
    totalConf+=c.confidence||0.5;
    // Prefer waste analysis from drop/presence shots where waste is actually visible
    if(c.waste_analysis&&c.waste_analysis.waste_visible&&!bestWaste)bestWaste=c.waste_analysis;
    else if(c.waste_analysis&&c.waste_analysis.waste_visible)bestWaste=c.waste_analysis; // always take latest visible
  });
  if(!valid)return{catPresent:false};
  const cat=Object.keys(catC).sort((a,b)=>catC[b]-catC[a])[0];
  const activity=Object.keys(actC).sort((a,b)=>actC[b]-actC[a])[0];
  return{catPresent:true,cat,activity,confidence:Math.round((totalConf/valid)*100),notes,identBasis,wasteAnalysis:bestWaste};
}

function checkHealth(entry,s){
  const alerts=[],logs=getLogs(),now=new Date(),today=now.toDateString();
  const tl=logs.filter(l=>new Date(l.timestamp).toDateString()===today&&l.cat===entry.cat);
  if(tl.length>=s.alertMaxDaily)alerts.push({type:'warn',msg:`${entry.catName} ${lang==='zh'?'ä»Šæ—¥å·²å¦‚å»':'has visited '}${tl.length+1}${t('timesToday')}`});
  if(entry.duration>s.alertMaxDuration*60)alerts.push({type:'warn',msg:`${lang==='zh'?'å–®æ¬¡å¦‚å»æ™‚é–“ ':'Session '}${Math.round(entry.duration/60)}${t('dm')}${t('tooLong')}`});
  const lp=logs.find(l=>l.cat===entry.cat&&l.activity==='defecating');
  if(lp&&(now-new Date(lp.timestamp))/3600000>48)alerts.push({type:'alert',msg:`${entry.catName} ${t('noPoopSuffix')}`});
  // No elimination alert: cat was in box but didn't urinate or defecate
  const noElim=['investigating','covering','exiting','none'];
  if(s.noEliminationSecs>0&&noElim.includes(entry.activity)&&entry.duration>=s.noEliminationSecs)
    alerts.push({type:'alert',msg:`${entry.catName} ${t('noEliminationAlert')} (${Math.round(entry.duration/60)}${t('dm')})`});
  // Waste analysis health flags
  const wa=entry.wasteAnalysis;
  if(wa){
    if(wa.urine_color==='red_blood')alerts.push({type:'alert',msg:`${entry.catName} â€” âš ï¸ ${t('wfBloodUrine')}`});
    if(wa.urine_color==='dark_yellow'||wa.urine_color==='orange')alerts.push({type:'warn',msg:`${entry.catName} â€” ${t('wfDarkUrine')}`});
    if(wa.urine_clump_size==='small')alerts.push({type:'warn',msg:`${entry.catName} â€” ${t('wfSmallClump')}`});
    if(wa.feces_color==='red_tinged')alerts.push({type:'alert',msg:`${entry.catName} â€” âš ï¸ ${t('wfBloodFeces')}`});
    if(wa.feces_color==='dark_black')alerts.push({type:'alert',msg:`${entry.catName} â€” âš ï¸ ${t('wfBlackFeces')}`});
    if(wa.feces_consistency==='diarrhea')alerts.push({type:'warn',msg:`${entry.catName} â€” ${t('wfDiarrhea')}`});
    if(wa.straining_observed)alerts.push({type:'warn',msg:`${entry.catName} â€” ${t('wfStraining')}`});
    // Also parse any flags Claude itself flagged
    if(wa.waste_health_flags&&wa.waste_health_flags.length){
      wa.waste_health_flags.forEach(f=>{
        if(!alerts.some(a=>a.msg.includes(f)))
          alerts.push({type:'warn',msg:`${entry.catName} â€” ${f}`});
      });
    }
  }
  return alerts;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLAUDE API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function analyzeFrame(shotType='manual'){
  const s=loadSettings();if(!s.apiKey)return;
  const video=document.getElementById('videoEl');if(!video.videoWidth)return;
  setCamStatus(t('analyzing'),'analyzing');
  const cap=document.createElement('canvas');cap.width=640;cap.height=Math.round(640*video.videoHeight/video.videoWidth);
  cap.getContext('2d').drawImage(video,0,0,cap.width,cap.height);
  const liveB64=cap.toDataURL('image/jpeg',.7).split(',')[1];
  const cats=getCats();
  const catDesc=cats.map((c,i)=>{
    let d=`Cat ${i+1} â€” ID: ${c.id}, Name: ${c.name||'(unnamed)'}`;
    if(c.breed&&c.breed!==BREEDS.zh[0])d+=`, Breed: ${c.breed}`;
    if(c.desc)d+=`\nUnique features: ${c.desc}`;
    return d;
  }).join('\n\n');
  const catIds=cats.map(c=>`"${c.id}"`).join(' or ');
  const content=[];
  for(const c of cats){const ref=getRefPhoto(c.id);if(ref){content.push({type:'text',text:`Reference photo of ${c.name||c.id}:`});content.push({type:'image',source:{type:'base64',media_type:'image/jpeg',data:ref}});}}
  const hasRefs=cats.some(c=>getRefPhoto(c.id));
  // Shot-specific context hint for Claude
  const doWaste = (shotType==='drop'||shotType==='presence_check');
  const shotHint={
    entry:'ENTRY SHOT â€” cat has just stepped in. Focus on cat identification. Waste analysis not needed yet.',
    drop:'SQUAT SHOT â€” motion dropped sharply, cat likely in elimination posture. Attempt waste analysis if anything is visible.',
    presence_check:'PRESENCE CHECK + WASTE ANALYSIS â€” cat may have left. (1) Is cat still present? (2) Now that cat may have moved, attempt full waste analysis of what is visible in the litter.',
    manual:'General analysis.'
  }[shotType]||'General analysis.';

  const wasteSchema = doWaste ? `,
  "waste_analysis": {
    "waste_visible": true or false,
    "urine_clump_size": "small" or "normal" or "large" or "none_visible",
    "urine_color": "normal_pale_yellow" or "dark_yellow" or "orange" or "red_blood" or "none_visible",
    "feces_present": true or false,
    "feces_color": "normal_brown" or "dark_black" or "pale_grey" or "red_tinged" or "none_visible",
    "feces_consistency": "normal" or "soft_loose" or "hard_small_pellets" or "diarrhea" or "none_visible",
    "straining_observed": true or false,
    "waste_health_flags": ["array of specific concerns you observe, empty array if none"]
  }` : `, "waste_analysis": null`;

  const prompt=`You are monitoring a cat litter box.

SHOT CONTEXT: ${shotHint}

CATS:
${catDesc}

${hasRefs?'Reference photos provided above. Use for direct visual comparison.':'No reference photos â€” use written descriptions only.'}

IDENTIFICATION:
1. Is litter box visible in the LIVE IMAGE?
2. Is any cat present?
3. If yes: compare against references + descriptions (size, coat, markings, face, ears, unique features)
4. If confidence < 0.5, set cat_identity to "unknown". DO NOT GUESS.
Confidence guide: 0.9+ clearly identified | 0.7â€“0.89 likely | 0.5â€“0.69 possible | <0.5 â†’ unknown

${doWaste?`WASTE ANALYSIS GUIDELINES (only if waste_analysis requested):
- Only report what is genuinely visible â€” do NOT guess or infer from context alone
- Urine clumps: look for clumped/darker areas of litter
- Feces: look for solid darker deposits
- If litter is fully covered/undisturbed, set waste_visible: false and all sub-fields to none_visible
- For health flags: note any unusual colouration, abnormal size, or behavioural signs of straining`:''}

Respond ONLY with valid JSON, no markdown:
{
  "litter_box_visible": true or false,
  "cat_present": true or false,
  "cat_identity": ${catIds} or "unknown" or "none",
  "identification_basis": "brief explanation or empty string",
  "activity": "urinating" or "defecating" or "investigating" or "covering" or "exiting" or "none",
  "confidence": 0.0 to 1.0,
  "health_notes": "behavioural observations or empty string"${wasteSchema}
}`;
  content.push({type:'text',text:'LIVE IMAGE:'});
  content.push({type:'image',source:{type:'base64',media_type:'image/jpeg',data:liveB64}});
  content.push({type:'text',text:prompt});
  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':s.apiKey,'anthropic-version':'2023-06-01'},body:JSON.stringify({model:s.apiModel,max_tokens:700,messages:[{role:'user',content}]})});
    if(!resp.ok){
      let errMsg;
      if(resp.status===401)errMsg=t('apiErr401');
      else if(resp.status===429)errMsg=t('apiErr429');
      else errMsg=`${t('apiErrGeneric')} (${resp.status})`;
      toast(errMsg,'error');
      setCamStatus(errMsg,'');
      // Notify via TG/Discord since those work independently of Claude API key
      await pushMsg(`ğŸš¨ ${errMsg}`,s);
      if(resp.status===401)stopCamera();
      return;
    }
    const data=await resp.json();const text=data.content?.[0]?.text||'';
    try{
      const result=JSON.parse(text.replace(/```json|```/g,'').trim());
      sessionApiCalls.push(result);
      const unk=result.cat_identity==='unknown'||result.cat_identity==='none';
      document.getElementById('sessionCatName').textContent=unk?t('actUnknown'):getCatName(result.cat_identity);
      document.getElementById('sessionActivity').textContent=translateActivity(result.activity);
      document.getElementById('sessionConf').textContent=Math.round((result.confidence||0)*100)+'%'+(unk?' âš ï¸':'');
    }catch(e){console.error('parse error',text);}
  }catch(e){
    // Network-level failure (offline, DNS, etc.)
    toast(t('apiErrNetwork'),'error');
    console.error('api error',e);
  }
  setCamStatus(t('inSession'),'in-session');
}

function translateActivity(act){
  const m={urinating:t('actPee'),defecating:t('actPoop'),investigating:t('actInvestigate'),covering:t('actCover'),exiting:t('actExit'),none:t('actNone')};
  return m[act]||t('actNone');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildMsg(entry,alerts){
  const eMap={urinating:'ğŸ’§',defecating:'ğŸ’©',investigating:'ğŸ‘€',covering:'â›',exiting:'ğŸšª'};
  const emoji=eMap[entry.activity]||'ğŸ±';
  const dur=entry.duration<60?entry.duration+t('ds'):Math.round(entry.duration/60)+t('dm');
  const time=new Date(entry.timestamp).toLocaleTimeString(lang==='zh'?'zh-HK':'en-GB',{hour:'2-digit',minute:'2-digit'});
  let msg=`${emoji} **${entry.catName}** ${t('sessionFor')}\nğŸ• ${time} ï½œ â± ${dur}\n${translateActivity(entry.activity)}\n`;
  if(entry.notes)msg+=`ğŸ“ ${entry.notes}\n`;
  // Waste summary (only if visible and has meaningful data)
  const wa=entry.wasteAnalysis;
  if(wa&&wa.waste_visible){
    msg+=`\nğŸ”¬ ${t('wasteAnalysis')}\n`;
    if(wa.urine_clump_size&&wa.urine_clump_size!=='none_visible')msg+=`â€¢ ${t('urineClump')}: ${translateWasteClump(wa.urine_clump_size)}\n`;
    if(wa.urine_color&&wa.urine_color!=='none_visible')msg+=`â€¢ ${t('urineColor')}: ${translateUrineColor(wa.urine_color)}\n`;
    if(wa.feces_present){
      if(wa.feces_color&&wa.feces_color!=='none_visible')msg+=`â€¢ ${t('fecesColor')}: ${translateFecesColor(wa.feces_color)}\n`;
      if(wa.feces_consistency&&wa.feces_consistency!=='none_visible')msg+=`â€¢ ${t('fecesConsist')}: ${translateFecesConsist(wa.feces_consistency)}\n`;
    }
    if(wa.straining_observed)msg+=`â€¢ âš ï¸ ${t('straining')}\n`;
  }
  if(alerts.length){msg+=`\nâš ï¸ **${t('healthAlerts')}**\n`;alerts.forEach(a=>msg+=`â€¢ ${a.msg}\n`);}
  return msg;
}

async function sendNotifications(entry,s,alerts){
  const mode=s.notifMode||'all';
  // 'alerts' mode: only send if there are health alerts
  if(mode==='alerts'&&!alerts.length)return;
  // 'daily' mode: don't send per-visit, handled by daily summary scheduler
  if(mode==='daily')return;
  const msg=buildMsg(entry,alerts);
  await pushMsg(msg,s);
}

async function pushMsg(msg,s){
  if(s.discordWebhook){try{await fetch(s.discordWebhook,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:msg,username:'ğŸ± Cat Monitor'})});}catch(e){}}
  if(s.tgToken&&s.tgChatId){try{await fetch(`https://api.telegram.org/bot${s.tgToken}/sendMessage`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id:s.tgChatId,text:msg.replace(/\*\*/g,'*'),parse_mode:'Markdown'})});}catch(e){}}
}

function buildDailySummary(){
  const s=loadSettings(),cats=getCats(),logs=getLogs();
  const today=new Date().toDateString();
  const tl=logs.filter(l=>new Date(l.timestamp).toDateString()===today);
  if(!tl.length)return null;
  let msg=`${t('dailySummaryTitle')} â€” ${new Date().toLocaleDateString(lang==='zh'?'zh-HK':'en-GB',{month:'short',day:'numeric'})}\n\n`;
  cats.forEach(cat=>{
    const cl=tl.filter(l=>l.cat===cat.id);if(!cl.length)return;
    const pee=cl.filter(l=>l.activity==='urinating').length;
    const poop=cl.filter(l=>l.activity==='defecating').length;
    const noElim=cl.filter(l=>['investigating','none'].includes(l.activity)&&l.duration>=(s.noEliminationSecs||90)).length;
    msg+=`ğŸ± **${cat.name||'?'}**: ${t('visitCount')} ${cl.length} | ğŸ’§${pee} ğŸ’©${poop}`;
    if(noElim)msg+=` | âš ï¸ ${t('noEliminationAlert')} x${noElim}`;
    msg+='\n';
  });
  // Include any health alerts from today
  const todayAlerts=tl.filter(l=>l.alerts?.length>0);
  if(todayAlerts.length){
    msg+=`\nâš ï¸ **${t('healthAlerts')}**\n`;
    todayAlerts.forEach(l=>l.alerts.forEach(a=>msg+=`â€¢ ${l.catName}: ${a.msg}\n`));
  }
  return msg;
}

function scheduleDailySummary(){
  const now=new Date(),target=new Date();
  target.setHours(8,0,0,0);
  if(now>=target)target.setDate(target.getDate()+1);
  const ms=target-now;
  setTimeout(async()=>{
    const s=loadSettings();
    if(s.notifMode==='daily'){
      const msg=buildDailySummary();
      if(msg)await pushMsg(msg,s);
    }
    scheduleDailySummary(); // reschedule for next day
  },ms);
}

async function testDiscord(){const url=v('discordWebhook');if(!url){toast(t('discordFillAll'),'error');return;}try{await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:`âœ… ${t('appTitle')} â€” ${t('testDiscordBtn')} OK ğŸ±`,username:'ğŸ± Cat Monitor'})});toast(t('discordOK'),'success');}catch(e){toast(t('discordFail'),'error');}}
async function testTelegram(){const token=v('tgToken'),chatId=v('tgChatId');if(!token||!chatId){toast(t('tgFillAll'),'error');return;}try{const r=await fetch(`https://api.telegram.org/bot${token}/sendMessage`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id:chatId,text:`âœ… ${t('appTitle')} â€” ${t('testTelegramBtn')} OK ğŸ±`})});const d=await r.json();d.ok?toast(t('tgOK'),'success'):toast(t('tgFail')+': '+d.description,'error');}catch(e){toast(t('tgFail'),'error');}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupROICanvas(){
  const c=document.getElementById('roiCanvas');c.width=c.offsetWidth;c.height=c.offsetHeight;
  ['touchstart','mousedown'].forEach(ev=>c.addEventListener(ev,onROIStart,{passive:false}));
  ['touchmove','mousemove'].forEach(ev=>c.addEventListener(ev,onROIMove,{passive:false}));
  ['touchend','mouseup'].forEach(ev=>c.addEventListener(ev,onROIEnd));
}
function getPos(e,c){const r=c.getBoundingClientRect(),tp=e.touches?e.touches[0]:e;return{x:(tp.clientX-r.left)/r.width,y:(tp.clientY-r.top)/r.height};}
function onROIStart(e){e.preventDefault();roiStart=getPos(e,document.getElementById('roiCanvas'));isDrawingROI=true;}
function onROIMove(e){e.preventDefault();if(!isDrawingROI)return;const c=document.getElementById('roiCanvas'),p=getPos(e,c);roi={x:Math.min(roiStart.x,p.x),y:Math.min(roiStart.y,p.y),w:Math.abs(p.x-roiStart.x),h:Math.abs(p.y-roiStart.y)};drawROI();}
function onROIEnd(){isDrawingROI=false;if(roi&&roi.w<.05){roi=null;drawROI();}}
function drawROI(){
  const c=document.getElementById('roiCanvas'),ctx=c.getContext('2d');
  c.width=c.offsetWidth;c.height=c.offsetHeight;ctx.clearRect(0,0,c.width,c.height);
  if(!roi)return;
  const W=c.width,H=c.height;
  ctx.strokeStyle='#00e5b0';ctx.lineWidth=2;ctx.setLineDash([6,3]);
  ctx.strokeRect(roi.x*W,roi.y*H,roi.w*W,roi.h*H);
  ctx.fillStyle='rgba(0,229,176,.08)';ctx.fillRect(roi.x*W,roi.y*H,roi.w*W,roi.h*H);
  ctx.setLineDash([]);ctx.fillStyle='#00e5b0';ctx.font='10px Space Mono,monospace';
  ctx.fillText(lang==='zh'?'è²“ç ‚ç›¤å€åŸŸ':'Litter Box',roi.x*W+4,roi.y*H+14);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentFilter='all';

function renderLogFilter(){
  const cats=getCats();
  document.getElementById('logFilterRow').innerHTML=
    `<button class="filter-btn ${currentFilter==='all'?'active':''}" onclick="setFilter('all',this)">${t('filterAll')}</button>`
    +cats.map(c=>`<button class="filter-btn ${currentFilter===c.id?'active':''}" onclick="setFilter('${c.id}',this)" ${currentFilter===c.id?`style="border-color:${c.colorDot};color:${c.colorDot};background:${c.colorDot}22"`:''}><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${c.colorDot};margin-right:4px;vertical-align:middle"></span>${c.name||'?'}</button>`).join('')
    +`<button class="filter-btn ${currentFilter==='pee'?'active':''}" onclick="setFilter('pee',this)">${t('filterPee')}</button>`
    +`<button class="filter-btn ${currentFilter==='poop'?'active':''}" onclick="setFilter('poop',this)">${t('filterPoop')}</button>`
    +`<button class="filter-btn ${currentFilter==='alert'?'active':''}" onclick="setFilter('alert',this)">${t('filterAlert')}</button>`;
}

function setFilter(f,btn){
  currentFilter=f;
  document.querySelectorAll('.filter-btn').forEach(b=>{b.classList.remove('active');b.style.cssText='';});
  btn.classList.add('active');
  const cat=getCats().find(c=>c.id===f);
  if(cat){btn.style.borderColor=cat.colorDot;btn.style.color=cat.colorDot;btn.style.background=cat.colorDot+'22';}
  renderLog();
}

function renderRecentEvents(){
  const logs=getLogs().slice(0,5),el=document.getElementById('recentEvents');
  if(!logs.length){el.innerHTML=`<div class="no-events">${t('noRecordsMsg')}</div>`;return;}
  el.innerHTML=logs.map(l=>eventItemHTML(l)).join('');
}

function eventItemHTML(l){
  const color=getCatColor(l.cat);
  const bc=l.activity==='urinating'?'pee':l.activity==='defecating'?'poop':'visit';
  const dur=l.duration<60?l.duration+t('ds'):Math.round(l.duration/60)+t('dm');
  return `<div class="event-item">
    <div class="cat-dot" style="background:${color}"></div>
    <div class="event-body">
      <div class="event-title">${l.catName} Â· ${translateActivity(l.activity)}</div>
      <div class="event-sub">${dur} Â· ${t('confidenceLabel')} ${l.confidence}%</div>
    </div>
    ${l.alerts?.length?'<span class="badge alert">âš ï¸</span>':''}
    <span class="badge ${bc}">${l.activity==='urinating'?t('filterPee'):l.activity==='defecating'?t('filterPoop'):'?'}</span>
    <div class="event-time">${formatTime(new Date(l.timestamp))}</div>
  </div>`;
}

function renderLog(){
  let logs=getLogs();
  if(currentFilter!=='all'&&currentFilter!=='pee'&&currentFilter!=='poop'&&currentFilter!=='alert'){
    logs=logs.filter(l=>l.cat===currentFilter);
  }else if(currentFilter==='pee')logs=logs.filter(l=>l.activity==='urinating');
  else if(currentFilter==='poop')logs=logs.filter(l=>l.activity==='defecating');
  else if(currentFilter==='alert')logs=logs.filter(l=>l.alerts?.length>0);
  const el=document.getElementById('logContainer');
  if(!logs.length){el.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ“‹</div>${t('logEmptyMsg')}</div>`;return;}
  const groups={};
  logs.forEach(l=>{const d=new Date(l.timestamp).toLocaleDateString(lang==='zh'?'zh-HK':'en-GB',{year:'numeric',month:'long',day:'numeric'});if(!groups[d])groups[d]=[];groups[d].push(l);});
  el.innerHTML=Object.entries(groups).map(([date,entries])=>`<div class="log-date-group"><div class="log-date-label">${date}</div>${entries.map(l=>logEntryHTML(l)).join('')}</div>`).join('');
}

function translateWasteClump(v){return{small:t('uSmall'),normal:t('uNormal'),large:t('uLarge'),none_visible:'â€”'}[v]||'â€”';}
function translateUrineColor(v){return{normal_pale_yellow:t('ucNormal'),dark_yellow:t('ucDark'),orange:t('ucOrange'),red_blood:t('ucBlood'),none_visible:'â€”'}[v]||'â€”';}
function translateFecesColor(v){return{normal_brown:t('fcNormal'),dark_black:t('fcBlack'),pale_grey:t('fcPale'),red_tinged:t('fcRed'),none_visible:'â€”'}[v]||'â€”';}
function translateFecesConsist(v){return{normal:t('fsNormal'),soft_loose:t('fsSoft'),hard_small_pellets:t('fsHard'),diarrhea:t('fsDiarrhea'),none_visible:'â€”'}[v]||'â€”';}
function wasteColorClass(field,val){
  if(field==='uc'&&(val==='red_blood'))return 'alert';
  if(field==='uc'&&(val==='dark_yellow'||val==='orange'))return 'warn';
  if(field==='fc'&&(val==='red_tinged'||val==='dark_black'))return 'alert';
  if(field==='fc'&&(val==='pale_grey'))return 'warn';
  if(field==='fs'&&val==='diarrhea')return 'warn';
  return '';
}

function wasteAnalysisHTML(wa){
  if(!wa)return '';
  if(!wa.waste_visible)return `<div class="waste-panel"><div class="waste-panel-title">${t('wasteAnalysis')}</div><span style="font-size:10px;color:var(--text-dim)">${t('wasteNotVisible')}</span></div>`;
  const flags=(wa.waste_health_flags||[]).map(f=>`<span class="waste-flag warn">${f}</span>`).join('');
  const strainBadge=wa.straining_observed?`<span class="waste-flag">${t('straining')}</span>`:'';
  return `<div class="waste-panel">
    <div class="waste-panel-title">${t('wasteAnalysis')}</div>
    <div class="waste-grid">
      <div class="waste-item"><span class="wlabel">${t('urineClump')}</span><span class="wval ${wasteColorClass('uc',wa.urine_clump_size)}">${translateWasteClump(wa.urine_clump_size)}</span></div>
      <div class="waste-item"><span class="wlabel">${t('urineColor')}</span><span class="wval ${wasteColorClass('uc',wa.urine_color)}">${translateUrineColor(wa.urine_color)}</span></div>
      ${wa.feces_present?`<div class="waste-item"><span class="wlabel">${t('fecesColor')}</span><span class="wval ${wasteColorClass('fc',wa.feces_color)}">${translateFecesColor(wa.feces_color)}</span></div>
      <div class="waste-item"><span class="wlabel">${t('fecesConsist')}</span><span class="wval ${wasteColorClass('fs',wa.feces_consistency)}">${translateFecesConsist(wa.feces_consistency)}</span></div>`:''}
    </div>
    ${flags||strainBadge?`<div style="margin-top:5px">${strainBadge}${flags}</div>`:''}
  </div>`;
}

function logEntryHTML(l){
  const color=getCatColor(l.cat);
  const time=new Date(l.timestamp).toLocaleTimeString(lang==='zh'?'zh-HK':'en-GB',{hour:'2-digit',minute:'2-digit'});
  const dur=l.duration<60?l.duration+t('ds'):Math.round(l.duration/60)+t('dm');
  const bc=l.activity==='urinating'?'pee':l.activity==='defecating'?'poop':'visit';
  const alertHTML=l.alerts?.length?l.alerts.map(a=>`<div class="alert-card ${a.type==='warn'?'warn':''}"><div class="alert-title">${a.type==='warn'?t('warnLabel'):t('alertLabel')}</div><div class="alert-body">${a.msg}</div></div>`).join(''):'';
  return `<div class="log-entry">
    <div class="log-entry-header">
      <div class="cat-dot" style="background:${color}"></div>
      <strong style="font-size:13px;color:var(--text-bright)">${l.catName}</strong>
      <span class="badge ${bc}">${translateActivity(l.activity)}</span>
      <span style="margin-left:auto;font-size:11px;color:var(--text-dim)">${time}</span>
    </div>
    ${l.notes?`<div class="log-entry-notes">ã€Œ${l.notes}ã€</div>`:''}
    ${l.identBasis?`<div class="log-ident">${t('identBasisPfx')} ${l.identBasis}</div>`:''}
    <div class="log-entry-meta"><span>â± ${dur}</span><span>ğŸ¯ ${l.confidence}%</span></div>
    ${wasteAnalysisHTML(l.wasteAnalysis)}
    ${alertHTML}
  </div>`;
}

function renderStats(){
  const el=document.getElementById('statsContainer'),logs=getLogs(),cats=getCats();
  if(!logs.length){el.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ“Š</div>${t('statsEmptyMsg')}</div>`;return;}
  const now=new Date(),today=now.toDateString(),weekAgo=new Date(now-7*86400000);
  const s=loadSettings();
  const healthAlerts=generateHealthAlerts(logs,s);
  const alertHTML=healthAlerts.map(a=>`<div class="alert-card ${a.type==='warn'?'warn':''}"><div class="alert-title">${a.type==='warn'?t('warnLabel'):t('alertLabel')}</div><div class="alert-body">${a.msg}</div></div>`).join('');
  const catPanels=cats.map(cat=>{
    const cl=logs.filter(l=>l.cat===cat.id);
    const tl=cl.filter(l=>new Date(l.timestamp).toDateString()===today);
    const wl=cl.filter(l=>new Date(l.timestamp)>=weekAgo);
    const pee=wl.filter(l=>l.activity==='urinating').length;
    const poop=wl.filter(l=>l.activity==='defecating').length;
    const avgDur=wl.length?Math.round(wl.reduce((a,l)=>a+l.duration,0)/wl.length):0;
    const last=cl[0]?relativeTime(new Date(cl[0].timestamp)):t('noLog');
    return `<div class="cat-panel">
      <div class="cat-panel-header">
        <div class="cat-avatar" style="background:${cat.colorDot}22;border:2px solid ${cat.colorDot}">ğŸ±</div>
        <div><div class="cat-panel-name">${cat.name||'?'}</div><div style="font-size:10px;color:var(--text-dim)">${t('lastVisit')}${last}</div></div>
      </div>
      <div class="cat-stats">
        <div class="mini-stat"><div class="val">${tl.length}</div><div class="lbl">${t('todayCount')}</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--blue)">${pee}</div><div class="lbl">${t('weekPee')}</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--amber)">${poop}</div><div class="lbl">${t('weekPoop')}</div></div>
      </div>
      <div style="margin-top:8px;font-size:10px;color:var(--text-dim)">${t('avgPerSession')} ${avgDur}${t('ds')} ï½œ ${t('weekVisits')} ${wl.length}</div>
    </div>`;
  }).join('');
  const timelineRows=cats.map(cat=>{
    const tl=logs.filter(l=>l.cat===cat.id&&new Date(l.timestamp).toDateString()===today);
    const evts=tl.map(l=>{
      const d=new Date(l.timestamp),pct=(d.getHours()*60+d.getMinutes())/(24*60)*100,dp=Math.max(.5,(l.duration/86400)*100);
      const c=l.activity==='urinating'?'#4dd0e1':l.activity==='defecating'?'#ffb74d':cat.colorDot;
      return `<div class="timeline-event" style="left:${pct}%;width:${dp}%;background:${c};opacity:.85"></div>`;
    }).join('');
    return `<div class="timeline-row"><div class="timeline-cat-label">${cat.name||'?'}</div><div class="timeline-bar">${evts}</div></div>`;
  }).join('');
  const weekTotal=logs.filter(l=>new Date(l.timestamp)>=weekAgo).length;
  el.innerHTML=`${alertHTML}${catPanels}
    <div class="section-title">${t('todayTimeline')}</div>
    <div class="timeline-wrap">
      <div class="timeline-hours">${['0','6','12','18','24'].map(h=>`<span>${h}</span>`).join('')}</div>
      ${timelineRows}
      <div style="display:flex;gap:12px;margin-top:5px;font-size:9px;color:var(--text-dim)"><span style="color:#4dd0e1">${t('peeLabel')}</span><span style="color:#ffb74d">${t('poopLabel')}</span></div>
    </div>
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-val">${weekTotal}</div><div class="stat-label">${t('weekTotal')}</div></div>
      <div class="stat-card"><div class="stat-val">${logs.length}</div><div class="stat-label">${t('allTotal')}</div></div>
    </div>`;
}

function generateHealthAlerts(logs,s){
  const alerts=[],now=new Date();
  getCats().forEach(cat=>{
    const cl=logs.filter(l=>l.cat===cat.id);if(!cl.length)return;
    const hrs=(now-new Date(cl[0].timestamp))/3600000;
    if(s.alertNoVisit>0&&hrs>s.alertNoVisit)alerts.push({type:'alert',msg:`${cat.name||'?'} ${lang==='zh'?'è¶…é ':''}${Math.round(hrs)}${t('hrAgo')}${t('hrAgoSuffix')}`});
    const tc=cl.filter(l=>new Date(l.timestamp).toDateString()===now.toDateString()).length;
    if(tc>=s.alertMaxDaily)alerts.push({type:'warn',msg:`${cat.name||'?'} ${lang==='zh'?'ä»Šæ—¥å·²å¦‚å» ':''}${tc}${t('timesToday')}`});
  });
  return alerts;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+tab).classList.add('active');
  document.getElementById('tab-'+tab).classList.add('active');
  if(tab==='log'){renderLogFilter();renderLog();}
  if(tab==='stats')renderStats();
}
function setStatusDot(state){const d=document.getElementById('statusDot');d.className='status-dot'+(state?' '+state:'');}
function setOverlay(txt){document.getElementById('camOverlay').textContent=txt;}
function setCamStatus(txt,cls){const e=document.getElementById('camStatus');e.textContent=txt;e.className='cam-status'+(cls?' '+cls:'');}
function updateMotionMeter(pct){const f=document.getElementById('motionFill');f.style.width=pct+'%';f.className='meter-fill'+(pct>60?' fire':pct>30?' hot':'');document.getElementById('motionVal').textContent=pct+'%';}
function formatTime(d){return d.toLocaleTimeString(lang==='zh'?'zh-HK':'en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit'});}
function relativeTime(d){const s=Math.round((Date.now()-d)/1000);if(s<60)return s+t('secAgo');if(s<3600)return Math.round(s/60)+t('minAgo');if(s<86400)return Math.round(s/3600)+t('hrAgo');return Math.round(s/86400)+t('dayAgo');}

let toastTimer;
function toast(msg,type=''){const e=document.getElementById('toast');e.textContent=msg;e.className='toast show'+(type?' '+type:'');clearTimeout(toastTimer);toastTimer=setTimeout(()=>e.classList.remove('show'),3000);}

function init(){
  loadSettingsToForm();renderCatCards();renderLogFilter();renderRecentEvents();applyLang();
  if(loadSettings().apiKey)document.getElementById('setupOverlay').classList.add('hidden');
  scheduleDailySummary();
  setInterval(()=>{const s=loadSettings();const a=generateHealthAlerts(getLogs(),s);if(a.length)pushMsg(buildMsg({catName:'',cat:'none',activity:'none',duration:0,confidence:0,notes:'',timestamp:new Date().toISOString()},a).replace(/^.*?\n/,'â° Health Check\n'),s);},6*3600000);
}
init();
</script>
</body>
</html>
