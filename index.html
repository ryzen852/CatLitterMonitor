<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>ğŸ± è²“è²“å»æ‰€ç›£å¯Ÿç«™</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080c12;
    --surface: #0e1520;
    --surface2: #141e2e;
    --border: #1e2d42;
    --teal: #00e5b0;
    --teal-dim: #00a87e;
    --teal-glow: rgba(0,229,176,0.15);
    --amber: #ffb74d;
    --red: #ff5252;
    --blue: #4dd0e1;
    --text: #c8d8e8;
    --text-dim: #5a7a96;
    --text-bright: #e8f4ff;
    --mono: 'Space Mono', monospace;
    --sans: 'Syne', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    padding: 12px 16px 0;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
  }
  header h1 {
    font-family: var(--sans);
    font-weight: 800;
    font-size: 18px;
    color: var(--text-bright);
    letter-spacing: -0.5px;
  }
  header h1 span { color: var(--teal); }
  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--text-dim);
    flex-shrink: 0;
    margin-left: auto;
    transition: background 0.3s;
  }
  .status-dot.active { background: var(--teal); box-shadow: 0 0 8px var(--teal); animation: pulse 2s infinite; }
  .status-dot.motion { background: var(--amber); box-shadow: 0 0 8px var(--amber); animation: pulse 0.5s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  /* â”€â”€ TABS â”€â”€ */
  nav {
    display: flex;
    padding: 10px 16px 0;
    gap: 4px;
    flex-shrink: 0;
    border-bottom: 1px solid var(--border);
  }
  nav button {
    background: none;
    border: none;
    color: var(--text-dim);
    font-family: var(--mono);
    font-size: 11px;
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all 0.2s;
    white-space: nowrap;
  }
  nav button.active { color: var(--teal); border-bottom-color: var(--teal); }
  nav button:hover:not(.active) { color: var(--text); }

  /* â”€â”€ PAGES â”€â”€ */
  .pages { flex: 1; overflow: hidden; position: relative; }
  .page { 
    position: absolute; inset: 0; 
    overflow-y: auto; 
    padding: 16px;
    display: none;
  }
  .page.active { display: block; }

  /* â”€â”€ MONITOR PAGE â”€â”€ */
  .camera-wrap {
    position: relative;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border);
    aspect-ratio: 4/3;
    max-height: 280px;
  }
  #videoEl {
    width: 100%; height: 100%;
    object-fit: cover;
    display: block;
  }
  #roiCanvas {
    position: absolute; inset: 0;
    width: 100%; height: 100%;
    cursor: crosshair;
    touch-action: none;
  }
  .cam-overlay {
    position: absolute;
    top: 8px; left: 8px;
    background: rgba(8,12,18,0.8);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 10px;
    color: var(--teal);
    backdrop-filter: blur(4px);
  }
  .cam-status {
    position: absolute;
    bottom: 8px; right: 8px;
    background: rgba(8,12,18,0.85);
    border-radius: 6px;
    padding: 4px 10px;
    font-size: 10px;
    color: var(--text-dim);
  }
  .cam-status.in-session { color: var(--amber); border: 1px solid var(--amber); }
  .cam-status.analyzing { color: var(--blue); border: 1px solid var(--blue); }

  .monitor-controls {
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }
  .btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 11px;
    padding: 8px 14px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .btn:hover { border-color: var(--teal); color: var(--teal); }
  .btn.primary { background: var(--teal); color: #080c12; border-color: var(--teal); font-weight: 700; }
  .btn.primary:hover { background: var(--teal-dim); }
  .btn.danger { border-color: var(--red); color: var(--red); }
  .btn:disabled { opacity: 0.4; cursor: default; }
  .btn.full { flex: 1; }

  /* ROI hint */
  .hint {
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 6px;
    text-align: center;
  }

  /* motion meter */
  .motion-meter-wrap {
    margin-top: 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px;
  }
  .meter-label {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    color: var(--text-dim);
    margin-bottom: 6px;
  }
  .meter-bar {
    height: 6px;
    background: var(--surface2);
    border-radius: 3px;
    overflow: hidden;
  }
  .meter-fill {
    height: 100%;
    background: var(--teal);
    border-radius: 3px;
    transition: width 0.2s;
    width: 0%;
  }
  .meter-fill.hot { background: var(--amber); }
  .meter-fill.fire { background: var(--red); }

  /* current session card */
  .session-card {
    margin-top: 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px;
    display: none;
  }
  .session-card.visible { display: block; border-color: var(--amber); }
  .session-title {
    font-family: var(--sans);
    font-size: 13px;
    color: var(--amber);
    font-weight: 700;
    margin-bottom: 8px;
  }
  .session-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
    font-size: 11px;
  }
  .info-item label { color: var(--text-dim); display: block; font-size: 9px; margin-bottom: 2px; }
  .info-item span { color: var(--text-bright); }

  /* recent events */
  .section-title {
    font-family: var(--sans);
    font-size: 13px;
    font-weight: 700;
    color: var(--text-bright);
    margin: 16px 0 8px;
  }
  .event-list { display: flex; flex-direction: column; gap: 6px; }
  .event-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .event-cat-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .event-body { flex: 1; min-width: 0; }
  .event-title { font-size: 12px; color: var(--text-bright); }
  .event-sub { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
  .event-time { font-size: 10px; color: var(--text-dim); text-align: right; flex-shrink: 0; }
  .badge {
    padding: 2px 7px;
    border-radius: 4px;
    font-size: 9px;
    font-weight: 700;
    flex-shrink: 0;
  }
  .badge.pee { background: rgba(77,208,225,0.2); color: var(--blue); }
  .badge.poop { background: rgba(255,183,77,0.2); color: var(--amber); }
  .badge.visit { background: rgba(0,229,176,0.15); color: var(--teal); }
  .badge.alert { background: rgba(255,82,82,0.2); color: var(--red); }

  /* â”€â”€ ANALYTICS PAGE â”€â”€ */
  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 12px;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px;
  }
  .stat-card.full-width { grid-column: 1/-1; }
  .stat-val {
    font-family: var(--sans);
    font-size: 28px;
    font-weight: 800;
    color: var(--teal);
    line-height: 1;
    margin-bottom: 4px;
  }
  .stat-label { font-size: 10px; color: var(--text-dim); }
  .stat-sub { font-size: 11px; color: var(--text); margin-top: 6px; }

  .cat-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 8px;
  }
  .cat-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
  }
  .cat-avatar {
    width: 32px; height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }
  .cat-name {
    font-family: var(--sans);
    font-weight: 700;
    font-size: 14px;
    color: var(--text-bright);
  }
  .cat-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }
  .mini-stat { text-align: center; }
  .mini-stat .val { font-size: 18px; font-weight: 700; color: var(--teal); font-family: var(--sans); }
  .mini-stat .lbl { font-size: 9px; color: var(--text-dim); }

  /* health alerts */
  .alert-card {
    background: rgba(255,82,82,0.08);
    border: 1px solid rgba(255,82,82,0.3);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 8px;
  }
  .alert-card.warn {
    background: rgba(255,183,77,0.08);
    border-color: rgba(255,183,77,0.3);
  }
  .alert-title { font-size: 12px; color: var(--red); font-weight: 700; margin-bottom: 4px; }
  .alert-card.warn .alert-title { color: var(--amber); }
  .alert-body { font-size: 11px; color: var(--text); }

  /* timeline chart */
  .timeline-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 8px;
  }
  .timeline-hours {
    display: flex;
    justify-content: space-between;
    font-size: 9px;
    color: var(--text-dim);
    margin-bottom: 8px;
  }
  .timeline-row { 
    display: flex; 
    align-items: center; 
    gap: 8px;
    margin-bottom: 6px;
  }
  .timeline-cat-label { font-size: 10px; color: var(--text-dim); width: 50px; flex-shrink: 0; }
  .timeline-bar {
    flex: 1;
    height: 20px;
    background: var(--surface2);
    border-radius: 4px;
    position: relative;
    overflow: hidden;
  }
  .timeline-event {
    position: absolute;
    top: 2px; bottom: 2px;
    border-radius: 3px;
    min-width: 4px;
  }

  /* â”€â”€ LOG PAGE â”€â”€ */
  .log-filter {
    display: flex;
    gap: 6px;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }
  .filter-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-family: var(--mono);
    font-size: 10px;
    padding: 5px 10px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .filter-btn.active { border-color: var(--teal); color: var(--teal); background: var(--teal-glow); }

  .log-date-group { margin-bottom: 16px; }
  .log-date-label {
    font-size: 10px;
    color: var(--text-dim);
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .log-entry {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    margin-bottom: 6px;
  }
  .log-entry-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .log-entry-notes { font-size: 10px; color: var(--text-dim); line-height: 1.5; font-style: italic; }
  .log-entry-meta { display: flex; gap: 12px; margin-top: 6px; font-size: 10px; color: var(--text-dim); }
  .log-entry-meta span { display: flex; align-items: center; gap: 4px; }

  /* â”€â”€ SETTINGS PAGE â”€â”€ */
  .settings-section {
    margin-bottom: 20px;
  }
  .settings-section-title {
    font-family: var(--sans);
    font-size: 11px;
    font-weight: 700;
    color: var(--teal);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
  }
  .field {
    margin-bottom: 12px;
  }
  .field label {
    display: block;
    font-size: 10px;
    color: var(--text-dim);
    margin-bottom: 6px;
  }
  .field input, .field select, .field textarea {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-bright);
    font-family: var(--mono);
    font-size: 12px;
    padding: 10px 12px;
    border-radius: 8px;
    outline: none;
    transition: border-color 0.2s;
  }
  .field input:focus, .field select:focus, .field textarea:focus {
    border-color: var(--teal);
  }
  .field input[type="range"] {
    padding: 0;
    background: none;
    border: none;
    cursor: pointer;
  }
  .field .field-row { display: flex; gap: 8px; }
  .field .field-row input { flex: 1; }
  .field .color-preview {
    width: 42px; height: 42px;
    border-radius: 8px;
    border: 1px solid var(--border);
    flex-shrink: 0;
  }
  .range-labels { display: flex; justify-content: space-between; font-size: 9px; color: var(--text-dim); margin-top: 3px; }

  .test-btn-row { display: flex; gap: 8px; flex-wrap: wrap; }

  /* PHOTO UPLOAD */
  .photo-upload-row { display: flex; gap: 10px; align-items: flex-start; }
  .photo-preview-wrap {
    flex-shrink: 0; width: 72px; height: 72px;
    border-radius: 10px; border: 2px dashed var(--border);
    background: var(--surface2); display: flex; flex-direction: column;
    align-items: center; justify-content: center; cursor: pointer;
    position: relative; overflow: hidden; transition: border-color 0.2s;
  }
  .photo-preview-wrap:hover { border-color: var(--teal); }
  .photo-preview-wrap img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
  .photo-preview-wrap .upload-icon { font-size: 20px; }
  .photo-preview-wrap .upload-label { font-size: 8px; color: var(--text-dim); margin-top: 2px; }
  .photo-preview-wrap input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; padding: 0; background: none; border: none; }
  .photo-fields { flex: 1; display: flex; flex-direction: column; gap: 6px; }
  .photo-fields input, .photo-fields textarea {
    width: 100%; background: var(--surface); border: 1px solid var(--border);
    color: var(--text-bright); font-family: var(--mono); font-size: 11px;
    padding: 8px 10px; border-radius: 8px; outline: none; resize: vertical; transition: border-color 0.2s;
  }
  .photo-fields input:focus, .photo-fields textarea:focus { border-color: var(--teal); }
  .id-tip { font-size: 10px; color: var(--text-dim); background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; margin-top: 6px; line-height: 1.5; }
  .id-tip strong { color: var(--teal); }

  /* â”€â”€ EMPTY STATE â”€â”€ */
  .empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-dim);
    font-size: 12px;
  }
  .empty-icon { font-size: 40px; margin-bottom: 12px; }

  /* â”€â”€ TOAST â”€â”€ */
  #toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-bright);
    font-size: 12px;
    padding: 10px 20px;
    border-radius: 20px;
    transition: transform 0.3s;
    z-index: 999;
    white-space: nowrap;
    max-width: 90vw;
    text-align: center;
  }
  #toast.show { transform: translateX(-50%) translateY(0); }
  #toast.success { border-color: var(--teal); color: var(--teal); }
  #toast.error { border-color: var(--red); color: var(--red); }

  /* â”€â”€ SCROLLBAR â”€â”€ */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* â”€â”€ SETUP OVERLAY â”€â”€ */
  #setupOverlay {
    position: fixed; inset: 0;
    background: var(--bg);
    z-index: 100;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 32px 24px;
    text-align: center;
  }
  #setupOverlay.hidden { display: none; }
  #setupOverlay h2 { font-family: var(--sans); font-size: 24px; font-weight: 800; color: var(--text-bright); margin-bottom: 8px; }
  #setupOverlay p { font-size: 12px; color: var(--text-dim); margin-bottom: 24px; line-height: 1.6; }

  .no-events { font-size: 11px; color: var(--text-dim); text-align: center; padding: 20px; }
</style>
</head>
<body>

<div id="setupOverlay">
  <div style="font-size:48px;margin-bottom:16px">ğŸ±</div>
  <h2>è²“è²“å»æ‰€ç›£å¯Ÿç«™</h2>
  <p>è«‹å…ˆåˆ°ã€Œè¨­å®šã€é å¡«å¯«<br>Claude API Key åŠå…©éš»è²“è²“è³‡æ–™<br>å†è¿”å›ã€Œç›£å¯Ÿã€å•Ÿå‹•é¡é ­</p>
  <button class="btn primary" style="margin-top:8px" onclick="document.getElementById('setupOverlay').classList.add('hidden'); switchTab('settings')">å‰å¾€è¨­å®š â†’</button>
  <button class="btn" style="margin-top:8px" onclick="document.getElementById('setupOverlay').classList.add('hidden')">æˆ‘å·²è¨­å®šå¥½</button>
</div>

<header>
  <div style="font-size:20px">ğŸ±</div>
  <h1>è²“è²“<span>å»æ‰€</span>ç›£å¯Ÿ</h1>
  <div class="status-dot" id="statusDot"></div>
</header>

<nav>
  <button class="active" onclick="switchTab('monitor')" id="tab-monitor">ğŸ“· ç›£å¯Ÿ</button>
  <button onclick="switchTab('log')" id="tab-log">ğŸ“‹ è¨˜éŒ„</button>
  <button onclick="switchTab('stats')" id="tab-stats">ğŸ“Š åˆ†æ</button>
  <button onclick="switchTab('settings')" id="tab-settings">âš™ï¸ è¨­å®š</button>
</nav>

<div class="pages">

  <!-- â•â• MONITOR PAGE â•â• -->
  <div class="page active" id="page-monitor">
    <div class="camera-wrap">
      <video id="videoEl" autoplay muted playsinline></video>
      <canvas id="roiCanvas"></canvas>
      <div class="cam-overlay" id="camOverlay">å¾…æ©Ÿä¸­</div>
      <div class="cam-status" id="camStatus">æœªå•Ÿå‹•</div>
    </div>
    <div class="hint" id="roiHint">å•Ÿå‹•é¡é ­å¾Œï¼Œé•·æŒ‰æ‹–æ›³è¨­å®šè²“ç ‚ç›¤ç¯„åœ</div>

    <div class="monitor-controls">
      <button class="btn primary full" id="btnStart" onclick="startCamera()">ğŸ¥ å•Ÿå‹•ç›£å¯Ÿ</button>
      <button class="btn" id="btnStop" onclick="stopCamera()" disabled>â¹ åœæ­¢</button>
    </div>

    <div class="motion-meter-wrap">
      <div class="meter-label">
        <span>å‹•æ…‹åµæ¸¬</span>
        <span id="motionVal">0%</span>
      </div>
      <div class="meter-bar"><div class="meter-fill" id="motionFill"></div></div>
    </div>

    <div class="session-card" id="sessionCard">
      <div class="session-title">ğŸ”´ é€²è¡Œä¸­ â€” <span id="sessionCatName">åµæ¸¬ä¸­...</span></div>
      <div class="session-info">
        <div class="info-item"><label>é–‹å§‹æ™‚é–“</label><span id="sessionStart">â€”</span></div>
        <div class="info-item"><label>æŒçºŒæ™‚é–“</label><span id="sessionDur">0s</span></div>
        <div class="info-item"><label>åˆ¤æ–·æ´»å‹•</label><span id="sessionActivity">åˆ†æä¸­...</span></div>
        <div class="info-item"><label>ä¿¡å¿ƒåº¦</label><span id="sessionConf">â€”</span></div>
      </div>
    </div>

    <div class="section-title">æœ€è¿‘è¨˜éŒ„</div>
    <div class="event-list" id="recentEvents">
      <div class="no-events">å°šç„¡è¨˜éŒ„</div>
    </div>
  </div>

  <!-- â•â• LOG PAGE â•â• -->
  <div class="page" id="page-log">
    <div class="log-filter">
      <button class="filter-btn active" onclick="setFilter('all', this)">å…¨éƒ¨</button>
      <button class="filter-btn" onclick="setFilter('cat1', this)" id="filterCat1Btn">è²“è²“1</button>
      <button class="filter-btn" onclick="setFilter('cat2', this)" id="filterCat2Btn">è²“è²“2</button>
      <button class="filter-btn" onclick="setFilter('pee', this)">å°¿å°¿</button>
      <button class="filter-btn" onclick="setFilter('poop', this)">å¤§ä¾¿</button>
      <button class="filter-btn" onclick="setFilter('alert', this)">âš ï¸ è­¦å‘Š</button>
    </div>
    <div id="logContainer">
      <div class="empty"><div class="empty-icon">ğŸ“‹</div>è¨˜éŒ„æœƒåœ¨è²“è²“ä½¿ç”¨å»æ‰€å¾Œå‡ºç¾</div>
    </div>
    <button class="btn danger" style="width:100%;margin-top:16px" onclick="clearAllLogs()">æ¸…é™¤æ‰€æœ‰è¨˜éŒ„</button>
  </div>

  <!-- â•â• STATS PAGE â•â• -->
  <div class="page" id="page-stats">
    <div id="statsContainer">
      <div class="empty"><div class="empty-icon">ğŸ“Š</div>æ”¶é›†åˆ°è¨˜éŒ„å¾Œæœƒé¡¯ç¤ºçµ±è¨ˆ</div>
    </div>
  </div>

  <!-- â•â• SETTINGS PAGE â•â• -->
  <div class="page" id="page-settings">
    <div class="settings-section">
      <div class="settings-section-title">ğŸ”‘ API è¨­å®š</div>
      <div class="field">
        <label>Claude API Key</label>
        <input type="password" id="apiKey" placeholder="sk-ant-...">
      </div>
      <div class="field">
        <label>Claude æ¨¡å‹ï¼ˆå»ºè­°ç”¨ Haiku æ…³éŒ¢ï¼‰</label>
        <select id="apiModel">
          <option value="claude-haiku-3-5-20251001">claude-haiku-3-5ï¼ˆ~$0.30/é€±ï¼Œæ¨è–¦ï¼‰</option>
          <option value="claude-sonnet-4-5-20251022">claude-sonnet-4-5ï¼ˆ~$1.20/é€±ï¼Œæ›´æº–ï¼‰</option>
        </select>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">ğŸ± è²“è²“è­˜åˆ¥è³‡æ–™</div>

      <div class="id-tip">
        <strong>è­˜åˆ¥æº–ç¢ºåº¦æç¤ºï¼š</strong><br>
        ä¸Šè¼‰æ¸…æ™°åƒè€ƒç›¸ â†’ å¡«å¯«å“ç¨® â†’ æè¿°ç¨ç‰¹ç‰¹å¾µï¼ˆæ„ˆè©³ç´°æ„ˆå¥½ï¼‰<br>
        åŒè‰²åŒå“ç¨®å˜…è²“ï¼ŒAI æœƒé <strong>é«”å‹å·®ç•°ã€é¢éƒ¨ç‰¹å¾µã€ç¨ç‰¹æ¨™è¨˜</strong>å€åˆ†<br>
        è‹¥çœŸä¿‚åˆ†å””åˆ°ï¼Œæœƒè¨˜ç‚ºã€ŒæœªçŸ¥ã€è€Œå””æœƒäº‚ä¼°
      </div>

      <!-- CAT 1 -->
      <div style="margin-top:14px;padding-top:10px;border-top:1px solid var(--border)">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
          <div id="cat1ColorDotPreview" style="width:12px;height:12px;border-radius:50%;background:#ff9800"></div>
          <span style="font-size:12px;color:var(--text-bright);font-weight:700">è²“è²“ä¸€</span>
          <input type="color" id="cat1ColorDot" value="#ff9800" style="width:28px;height:28px;border:none;background:none;cursor:pointer;margin-left:auto"
            oninput="document.getElementById('cat1ColorDotPreview').style.background=this.value">
        </div>
        <div class="photo-upload-row">
          <div class="photo-preview-wrap" id="cat1PhotoWrap">
            <span class="upload-icon">ğŸ“·</span>
            <span class="upload-label">åƒè€ƒç›¸</span>
            <input type="file" accept="image/*" id="cat1PhotoFile" onchange="handlePhotoUpload('cat1', this)">
          </div>
          <div class="photo-fields">
            <input type="text" id="cat1Name" placeholder="è²“è²“åå­—ï¼ˆä¾‹å¦‚ï¼šå¤šå¤šï¼‰">
            <input type="text" id="cat1Breed" placeholder="å“ç¨®ï¼ˆä¾‹å¦‚ï¼šè‹±çŸ­ã€ç·¬å› è²“ã€æ··ç¨®ï¼‰">
            <textarea id="cat1Desc" rows="3" placeholder="ç¨ç‰¹ç‰¹å¾µï¼šæ¯›è‰²èŠ±ç´‹ã€é«”å‹å¤§ç´°ã€é¢éƒ¨ç‰¹å¾µã€ä»»ä½•ç¨ç‰¹æ¨™è¨˜&#10;ä¾‹å¦‚ï¼šæ©™è‰²è™æ–‘ï¼Œå³çœ¼ä¸‹æœ‰ä¸€ç²’é»‘ç—£ï¼Œé«”å‹è¼ƒå¤§ï¼Œå°¾å·´è¼ƒçŸ­"></textarea>
          </div>
        </div>
      </div>

      <!-- CAT 2 -->
      <div style="margin-top:14px;padding-top:10px;border-top:1px solid var(--border)">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
          <div id="cat2ColorDotPreview" style="width:12px;height:12px;border-radius:50%;background:#9c27b0"></div>
          <span style="font-size:12px;color:var(--text-bright);font-weight:700">è²“è²“äºŒ</span>
          <input type="color" id="cat2ColorDot" value="#9c27b0" style="width:28px;height:28px;border:none;background:none;cursor:pointer;margin-left:auto"
            oninput="document.getElementById('cat2ColorDotPreview').style.background=this.value">
        </div>
        <div class="photo-upload-row">
          <div class="photo-preview-wrap" id="cat2PhotoWrap">
            <span class="upload-icon">ğŸ“·</span>
            <span class="upload-label">åƒè€ƒç›¸</span>
            <input type="file" accept="image/*" id="cat2PhotoFile" onchange="handlePhotoUpload('cat2', this)">
          </div>
          <div class="photo-fields">
            <input type="text" id="cat2Name" placeholder="è²“è²“åå­—ï¼ˆä¾‹å¦‚ï¼šå’ªå’ªï¼‰">
            <input type="text" id="cat2Breed" placeholder="å“ç¨®ï¼ˆä¾‹å¦‚ï¼šè‹±çŸ­ã€æ³¢æ–¯ã€æ··ç¨®ï¼‰">
            <textarea id="cat2Desc" rows="3" placeholder="ç¨ç‰¹ç‰¹å¾µï¼šæ¯›è‰²èŠ±ç´‹ã€é«”å‹å¤§ç´°ã€é¢éƒ¨ç‰¹å¾µã€ä»»ä½•ç¨ç‰¹æ¨™è¨˜&#10;ä¾‹å¦‚ï¼šå…¨é»‘è‰²ï¼Œèƒ¸å£æœ‰ä¸€æ’®ç™½æ¯›ï¼Œé«”å‹è¼ƒç´°ï¼Œè€³æœµè¼ƒå¤§"></textarea>
          </div>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">ğŸ”” é€šçŸ¥è¨­å®š</div>
      <div class="field">
        <label>Discord Webhook URL</label>
        <input type="url" id="discordWebhook" placeholder="https://discord.com/api/webhooks/...">
      </div>
      <div class="field">
        <label>Telegram Bot Token</label>
        <input type="text" id="tgToken" placeholder="123456789:AABBcc...">
      </div>
      <div class="field">
        <label>Telegram Chat IDï¼ˆä½ å˜… user ID æˆ– group IDï¼‰</label>
        <input type="text" id="tgChatId" placeholder="-1001234567890">
      </div>
      <div class="test-btn-row">
        <button class="btn" onclick="testDiscord()">æ¸¬è©¦ Discord</button>
        <button class="btn" onclick="testTelegram()">æ¸¬è©¦ Telegram</button>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">âš™ï¸ åµæ¸¬è¨­å®š</div>
      <div class="field">
        <label>å‹•æ…‹æ•æ„Ÿåº¦ï¼ˆæ•¸å€¼è¶Šä½è¶Šæ•æ„Ÿï¼‰<span id="sensitivityVal" style="color:var(--teal)">15%</span></label>
        <input type="range" id="sensitivity" min="3" max="30" value="15" oninput="document.getElementById('sensitivityVal').textContent=this.value+'%'">
        <div class="range-labels"><span>æ¥µæ•æ„Ÿ</span><span>ä¸€èˆ¬</span><span>ä½æ•æ„Ÿ</span></div>
      </div>
      <div class="field">
        <label>è§¸ç™¼å‰éœ€æŒçºŒéƒå‹•ï¼ˆç§’ï¼‰</label>
        <input type="number" id="triggerDelay" value="3" min="1" max="10">
      </div>
      <div class="field">
        <label>éœæ­¢å¤šå°‘ç§’å¾ŒçµæŸ session</label>
        <input type="number" id="sessionEndDelay" value="30" min="10" max="120">
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">ğŸ¥ å¥åº·è­¦å‘Šè¨­å®š</div>
      <div class="field">
        <label>å¤šå°‘å°æ™‚ç„¡è¨˜éŒ„ç™¼è­¦å‘Šï¼ˆ0=åœç”¨ï¼‰</label>
        <input type="number" id="alertNoVisit" value="24" min="0" max="72">
      </div>
      <div class="field">
        <label>æ¯æ—¥å¦‚å»æ¬¡æ•¸ä¸Šé™ï¼ˆè¶…éç™¼è­¦å‘Šï¼‰</label>
        <input type="number" id="alertMaxDaily" value="8" min="3" max="20">
      </div>
      <div class="field">
        <label>å–®æ¬¡å¦‚å»æœ€é•·æ™‚é–“è­¦å‘Šï¼ˆåˆ†é˜ï¼‰</label>
        <input type="number" id="alertMaxDuration" value="15" min="5" max="60">
      </div>
    </div>

    <button class="btn primary full" style="width:100%;margin-bottom:8px" onclick="saveSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
    <button class="btn full" style="width:100%" onclick="exportLogs()">ğŸ“¤ åŒ¯å‡ºè¨˜éŒ„ (JSON)</button>
  </div>

</div>

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let stream = null;
let motionWorker = null;
let analysisInterval = null;
let sessionEndTimer = null;
let sessionStartTime = null;
let sessionApiCalls = [];
let sessionTimerInterval = null;
let isInSession = false;
let motionStartTime = null;
let wakeLock = null;
let lastFrameData = null;
let motionPct = 0;
let currentFilter = 'all';

// ROI state
let roi = null; // {x,y,w,h} in 0-1 normalized coords
let isDrawingROI = false;
let roiStart = null;

const ANALYZE_INTERVAL_MS = 20000; // max once per 20s during session
let lastAnalyzeTime = 0;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULTS = {
  apiKey: '', apiModel: 'claude-haiku-3-5-20251001',
  cat1Name: 'è²“è²“ä¸€', cat1Breed: '', cat1Desc: '', cat1ColorDot: '#ff9800',
  cat2Name: 'è²“è²“äºŒ', cat2Breed: '', cat2Desc: '', cat2ColorDot: '#9c27b0',
  discordWebhook: '', tgToken: '', tgChatId: '',
  sensitivity: 15, triggerDelay: 3, sessionEndDelay: 30,
  alertNoVisit: 24, alertMaxDaily: 8, alertMaxDuration: 15
};

function loadSettings() {
  const s = JSON.parse(localStorage.getItem('catmon_settings') || '{}');
  return { ...DEFAULTS, ...s };
}

function saveSettings() {
  const s = {
    apiKey: v('apiKey'),
    apiModel: v('apiModel'),
    cat1Name: v('cat1Name'), cat1Breed: v('cat1Breed'), cat1Desc: v('cat1Desc'), cat1ColorDot: v('cat1ColorDot'),
    cat2Name: v('cat2Name'), cat2Breed: v('cat2Breed'), cat2Desc: v('cat2Desc'), cat2ColorDot: v('cat2ColorDot'),
    discordWebhook: v('discordWebhook'), tgToken: v('tgToken'), tgChatId: v('tgChatId'),
    sensitivity: +v('sensitivity'), triggerDelay: +v('triggerDelay'), sessionEndDelay: +v('sessionEndDelay'),
    alertNoVisit: +v('alertNoVisit'), alertMaxDaily: +v('alertMaxDaily'), alertMaxDuration: +v('alertMaxDuration')
  };
  localStorage.setItem('catmon_settings', JSON.stringify(s));
  applySettingsToUI(s);
  toast('âœ… è¨­å®šå·²å„²å­˜', 'success');
  document.getElementById('filterCat1Btn').textContent = s.cat1Name;
  document.getElementById('filterCat2Btn').textContent = s.cat2Name;
}

function v(id) { return document.getElementById(id)?.value || ''; }

function applySettingsToUI(s) {
  Object.keys(s).forEach(k => {
    const el = document.getElementById(k);
    if (el) el.value = s[k];
  });
  // Sync color dot previews
  if (s.cat1ColorDot) document.getElementById('cat1ColorDotPreview').style.background = s.cat1ColorDot;
  if (s.cat2ColorDot) document.getElementById('cat2ColorDotPreview').style.background = s.cat2ColorDot;
  // Restore photo previews
  ['cat1','cat2'].forEach(cat => {
    const stored = localStorage.getItem(`catmon_photo_${cat}`);
    if (stored) showPhotoPreview(cat, stored);
  });
}

function loadSettingsToForm() {
  const s = loadSettings();
  applySettingsToUI(s);
  document.getElementById('filterCat1Btn').textContent = s.cat1Name;
  document.getElementById('filterCat2Btn').textContent = s.cat2Name;
  document.getElementById('sensitivityVal').textContent = s.sensitivity + '%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getLogs() { return JSON.parse(localStorage.getItem('catmon_logs') || '[]'); }
function saveLogs(logs) { localStorage.setItem('catmon_logs', JSON.stringify(logs)); }

function addLog(entry) {
  const logs = getLogs();
  logs.unshift({ ...entry, id: Date.now() });
  // Keep max 500 entries
  if (logs.length > 500) logs.splice(500);
  saveLogs(logs);
  renderRecentEvents();
  renderLog();
  renderStats();
}

function clearAllLogs() {
  if (!confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰è¨˜éŒ„ï¼Ÿ')) return;
  localStorage.removeItem('catmon_logs');
  renderRecentEvents();
  renderLog();
  renderStats();
  toast('è¨˜éŒ„å·²æ¸…é™¤');
}

function exportLogs() {
  const logs = getLogs();
  const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `catmon_logs_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAMERA & MOTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startCamera() {
  const s = loadSettings();
  if (!s.apiKey) { toast('âŒ è«‹å…ˆå¡«å¯« Claude API Key', 'error'); switchTab('settings'); return; }

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: false
    });
    const video = document.getElementById('videoEl');
    video.srcObject = stream;
    await video.play();

    document.getElementById('btnStart').disabled = true;
    document.getElementById('btnStop').disabled = false;
    setStatusDot('active');
    setOverlay('ğŸ“· ç›£å¯Ÿä¸­');

    setupROICanvas();
    startMotionDetection();
    acquireWakeLock();

    if (!roi) {
      // Default ROI: center 60%
      roi = { x: 0.2, y: 0.2, w: 0.6, h: 0.6 };
      drawROI();
    }
  } catch (e) {
    toast('âŒ ç„¡æ³•å­˜å–é¡é ­: ' + e.message, 'error');
  }
}

function stopCamera() {
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  stopMotionDetection();
  if (wakeLock) { wakeLock.release(); wakeLock = null; }
  document.getElementById('btnStart').disabled = false;
  document.getElementById('btnStop').disabled = true;
  setStatusDot('');
  setOverlay('å¾…æ©Ÿä¸­');
  setCamStatus('æœªå•Ÿå‹•', '');
  if (isInSession) endSession(true);
}

async function acquireWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
    }
  } catch (e) { console.log('WakeLock not available'); }
}

// â”€â”€ Motion Detection â”€â”€
let motionCanvas, motionCtx, prevFrame;
let motionTimer = null;

function startMotionDetection() {
  motionCanvas = document.createElement('canvas');
  motionCtx = motionCanvas.getContext('2d', { willReadFrequently: true });
  motionCanvas.width = 160;
  motionCanvas.height = 120;
  prevFrame = null;

  motionTimer = setInterval(detectMotion, 500);
}

function stopMotionDetection() {
  if (motionTimer) { clearInterval(motionTimer); motionTimer = null; }
}

function detectMotion() {
  const video = document.getElementById('videoEl');
  if (!video.videoWidth) return;

  const W = motionCanvas.width, H = motionCanvas.height;
  motionCtx.drawImage(video, 0, 0, W, H);
  const frame = motionCtx.getImageData(0, 0, W, H);

  if (!prevFrame) { prevFrame = frame; return; }

  const s = loadSettings();
  const sensitivity = s.sensitivity;

  // ROI in pixel coords
  let rx = 0, ry = 0, rw = W, rh = H;
  if (roi) {
    rx = Math.floor(roi.x * W); ry = Math.floor(roi.y * H);
    rw = Math.floor(roi.w * W); rh = Math.floor(roi.h * H);
  }

  let diff = 0, count = 0;
  for (let y = ry; y < ry + rh; y++) {
    for (let x = rx; x < rx + rw; x++) {
      const i = (y * W + x) * 4;
      const d = Math.abs(frame.data[i] - prevFrame.data[i]) +
                Math.abs(frame.data[i+1] - prevFrame.data[i+1]) +
                Math.abs(frame.data[i+2] - prevFrame.data[i+2]);
      diff += d / 3;
      count++;
    }
  }
  const avgDiff = count > 0 ? diff / count : 0;
  motionPct = Math.min(100, Math.round(avgDiff / 2.55));
  prevFrame = frame;

  updateMotionMeter(motionPct);

  const threshold = sensitivity;
  const hasMotion = motionPct >= threshold;

  handleMotionState(hasMotion, s);
}

function handleMotionState(hasMotion, s) {
  const now = Date.now();

  if (hasMotion) {
    setStatusDot('motion');
    if (!motionStartTime) motionStartTime = now;

    // Reset end timer
    if (sessionEndTimer) { clearTimeout(sessionEndTimer); sessionEndTimer = null; }

    const elapsed = (now - motionStartTime) / 1000;
    if (elapsed >= s.triggerDelay && !isInSession) {
      startSession();
    }

    if (isInSession && (now - lastAnalyzeTime) > ANALYZE_INTERVAL_MS) {
      analyzeFrame();
      lastAnalyzeTime = now;
    }
  } else {
    setStatusDot(stream ? 'active' : '');
    if (isInSession && !sessionEndTimer) {
      sessionEndTimer = setTimeout(() => {
        endSession(false);
      }, s.sessionEndDelay * 1000);
    }
    if (!isInSession) motionStartTime = null;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startSession() {
  isInSession = true;
  sessionStartTime = new Date();
  sessionApiCalls = [];
  lastAnalyzeTime = 0;

  document.getElementById('sessionCard').classList.add('visible');
  document.getElementById('sessionStart').textContent = formatTime(sessionStartTime);
  document.getElementById('sessionCatName').textContent = 'åµæ¸¬ä¸­...';
  document.getElementById('sessionActivity').textContent = 'åˆ†æä¸­...';
  document.getElementById('sessionConf').textContent = 'â€”';

  sessionTimerInterval = setInterval(updateSessionDuration, 1000);
  setCamStatus('ğŸ”´ é€²è¡Œä¸­', 'in-session');
  setOverlay('ğŸ”´ Session é€²è¡Œä¸­');

  // Immediate first analysis
  analyzeFrame();
  lastAnalyzeTime = Date.now();
}

function updateSessionDuration() {
  if (!sessionStartTime) return;
  const secs = Math.round((Date.now() - sessionStartTime) / 1000);
  const m = Math.floor(secs / 60), s2 = secs % 60;
  document.getElementById('sessionDur').textContent =
    m > 0 ? `${m}m ${s2}s` : `${s2}s`;
}

async function endSession(aborted) {
  isInSession = false;
  if (sessionTimerInterval) { clearInterval(sessionTimerInterval); sessionTimerInterval = null; }
  if (sessionEndTimer) { clearTimeout(sessionEndTimer); sessionEndTimer = null; }
  motionStartTime = null;
  document.getElementById('sessionCard').classList.remove('visible');
  setCamStatus('ğŸ“· ç›£å¯Ÿä¸­', '');
  setOverlay('ğŸ“· ç›£å¯Ÿä¸­');

  if (aborted || sessionApiCalls.length === 0) return;

  // Final analysis if not done recently
  if ((Date.now() - lastAnalyzeTime) > 5000) {
    await analyzeFrame();
  }

  // Aggregate results
  const duration = Math.round((Date.now() - sessionStartTime) / 1000);
  const result = aggregateSession(sessionApiCalls, duration);

  if (!result.catPresent) return; // No cat detected, ignore

  const s = loadSettings();
  const entry = {
    timestamp: sessionStartTime.toISOString(),
    endTimestamp: new Date().toISOString(),
    duration,
    cat: result.cat,
    catName: result.cat === 'cat1' ? s.cat1Name : result.cat === 'cat2' ? s.cat2Name : 'æœªçŸ¥',
    activity: result.activity,
    confidence: result.confidence,
    notes: result.notes,
    identBasis: result.identBasis,
    alerts: []
  };

  // Health checks
  const alerts = checkHealth(entry, s);
  entry.alerts = alerts;

  addLog(entry);
  await sendNotifications(entry, s, alerts);
}

function aggregateSession(calls, duration) {
  if (calls.length === 0) return { catPresent: false };

  // Find most common cat & activity
  const catCounts = {};
  const actCounts = {};
  let notes = '';
  let identBasis = '';
  let totalConf = 0;
  let validCalls = 0;

  calls.forEach(c => {
    if (!c || !c.cat_present) return;
    validCalls++;
    const cat = c.cat_identity || 'unknown';
    catCounts[cat] = (catCounts[cat] || 0) + 1;
    const act = c.activity || 'unknown';
    actCounts[act] = (actCounts[act] || 0) + 1;
    if (c.health_notes) notes = c.health_notes;
    if (c.identification_basis) identBasis = c.identification_basis;
    totalConf += c.confidence || 0.5;
  });

  if (validCalls === 0) return { catPresent: false };

  const cat = Object.keys(catCounts).sort((a,b) => catCounts[b]-catCounts[a])[0];
  const activity = Object.keys(actCounts).sort((a,b) => actCounts[b]-actCounts[a])[0];

  return {
    catPresent: true,
    cat,
    activity,
    confidence: Math.round((totalConf / validCalls) * 100),
    notes,
    identBasis
  };
}

function checkHealth(entry, s) {
  const alerts = [];
  const logs = getLogs();
  const now = new Date();
  const today = now.toDateString();

  // Check daily count
  const todayLogs = logs.filter(l =>
    new Date(l.timestamp).toDateString() === today &&
    l.cat === entry.cat && l.catPresent !== false
  );
  if (todayLogs.length >= s.alertMaxDaily) {
    alerts.push({ type: 'warn', msg: `${entry.catName} ä»Šæ—¥å·²å¦‚å» ${todayLogs.length + 1} æ¬¡ï¼Œæ¬¡æ•¸åå¤š` });
  }

  // Check duration
  if (entry.duration > s.alertMaxDuration * 60) {
    alerts.push({ type: 'warn', msg: `å–®æ¬¡å¦‚å»æ™‚é–“ ${Math.round(entry.duration/60)} åˆ†é˜ï¼Œæ™‚é–“éé•·` });
  }

  // Check last poop (if we can detect)
  if (entry.activity === 'urinating') {
    // Check last defecation
    const lastPoop = logs.find(l => l.cat === entry.cat && l.activity === 'defecating');
    if (lastPoop) {
      const hoursSince = (now - new Date(lastPoop.timestamp)) / 3600000;
      if (hoursSince > 48) {
        alerts.push({ type: 'alert', msg: `${entry.catName} è¶…é 48 å°æ™‚æœªæœ‰å¤§ä¾¿è¨˜éŒ„` });
      }
    }
  }

  return alerts;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHOTO REFERENCE MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handlePhotoUpload(cat, input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    // Resize to max 512px to save localStorage space
    const img = new Image();
    img.onload = () => {
      const MAX = 512;
      const scale = Math.min(1, MAX / Math.max(img.width, img.height));
      const canvas = document.createElement('canvas');
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
      const base64 = canvas.toDataURL('image/jpeg', 0.75);
      try {
        localStorage.setItem(`catmon_photo_${cat}`, base64);
        showPhotoPreview(cat, base64);
        toast(`âœ… ${cat === 'cat1' ? 'è²“è²“ä¸€' : 'è²“è²“äºŒ'} åƒè€ƒç›¸å·²å„²å­˜`, 'success');
      } catch(e) {
        toast('âŒ ç›¸ç‰‡å¤ªå¤§ï¼Œè«‹é¸ç´°ä¸€å•²', 'error');
      }
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function showPhotoPreview(cat, base64) {
  const wrap = document.getElementById(`${cat}PhotoWrap`);
  if (!wrap) return;
  // Remove existing img if any
  const existing = wrap.querySelector('img');
  if (existing) existing.remove();
  const img = document.createElement('img');
  img.src = base64;
  wrap.appendChild(img);
}

function getRefPhoto(cat) {
  const stored = localStorage.getItem(`catmon_photo_${cat}`);
  if (!stored) return null;
  return stored.split(',')[1]; // return base64 data only
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLAUDE API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function analyzeFrame() {
  const s = loadSettings();
  if (!s.apiKey) return;

  const video = document.getElementById('videoEl');
  if (!video.videoWidth) return;

  setCamStatus('ğŸ”µ åˆ†æä¸­...', 'analyzing');

  // Capture live frame
  const cap = document.createElement('canvas');
  cap.width = 640; cap.height = Math.round(640 * video.videoHeight / video.videoWidth);
  cap.getContext('2d').drawImage(video, 0, 0, cap.width, cap.height);
  const liveBase64 = cap.toDataURL('image/jpeg', 0.7).split(',')[1];

  // Get reference photos
  const ref1 = getRefPhoto('cat1');
  const ref2 = getRefPhoto('cat2');
  const hasRefs = ref1 || ref2;

  // Build identification descriptions
  function catDesc(num, name, breed, desc) {
    let d = `Cat ${num} â€” Name: ${name}`;
    if (breed) d += `, Breed: ${breed}`;
    if (desc) d += `\nPhysical description: ${desc}`;
    return d;
  }

  const refNote = hasRefs
    ? `Reference photos of each cat are provided above the live image. Use them for DIRECT VISUAL COMPARISON.`
    : `No reference photos provided. Rely on the written descriptions.`;

  const prompt = `You are an AI monitoring a cat litter box. Your task is to identify which cat is present and what they are doing.

CATS IN THIS HOUSEHOLD:
${catDesc(1, s.cat1Name, s.cat1Breed, s.cat1Desc)}

${catDesc(2, s.cat2Name, s.cat2Breed, s.cat2Desc)}

${refNote}

IDENTIFICATION STRATEGY (apply in order):
1. Check if the litter box area is visible in the LIVE image
2. Check if any cat is present in the litter box
3. If cat present, compare against reference photos AND written descriptions:
   - Body size & build (larger/smaller)
   - Coat pattern, color, markings
   - Facial features (ear shape, eye color, face shape)
   - Any unique marks, spots, scars
4. If you cannot distinguish between the two cats with reasonable confidence, set cat_identity to "unknown" â€” DO NOT GUESS

CONFIDENCE GUIDE:
- 0.9+: Clearly identified, distinctive features match
- 0.7-0.89: Likely match, most features align
- 0.5-0.69: Possible match, some uncertainty
- <0.5: Cannot distinguish â†’ use "unknown"

HEALTH OBSERVATIONS (if cat present):
- Posture (squatting, straining, hunched?)
- Time spent (appears normal or prolonged?)
- Any visible signs of discomfort?
- Litter appearance if visible?

Respond ONLY with valid JSON, no markdown:
{
  "litter_box_visible": true or false,
  "cat_present": true or false,
  "cat_identity": "cat1" or "cat2" or "unknown" or "none",
  "identification_basis": "brief explanation of how you identified the cat, or why unknown",
  "activity": "urinating" or "defecating" or "investigating" or "covering" or "exiting" or "none",
  "confidence": number 0.0 to 1.0,
  "health_notes": "any health observations, empty string if none"
}`;

  // Build message content: ref photos first, then live frame
  const content = [];
  if (ref1) {
    content.push({ type: 'text', text: `ğŸ“· Reference photo of ${s.cat1Name}:` });
    content.push({ type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: ref1 } });
  }
  if (ref2) {
    content.push({ type: 'text', text: `ğŸ“· Reference photo of ${s.cat2Name}:` });
    content.push({ type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: ref2 } });
  }
  content.push({ type: 'text', text: 'ğŸ”´ LIVE IMAGE (analyze this):' });
  content.push({ type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: liveBase64 } });
  content.push({ type: 'text', text: prompt });

  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-api-key': s.apiKey, 'anthropic-version': '2023-06-01' },
      body: JSON.stringify({ model: s.apiModel, max_tokens: 400, messages: [{ role: 'user', content }] })
    });

    if (!resp.ok) { console.error('API error', resp.status); return; }
    const data = await resp.json();
    const text = data.content?.[0]?.text || '';

    try {
      const clean = text.replace(/```json|```/g, '').trim();
      const result = JSON.parse(clean);
      sessionApiCalls.push(result);

      // Update session card
      const catName = result.cat_identity === 'cat1' ? s.cat1Name :
                      result.cat_identity === 'cat2' ? s.cat2Name : 'æœªçŸ¥';
      document.getElementById('sessionCatName').textContent =
        result.cat_identity === 'unknown' ? 'â“ åˆ†å””æ¸…' : catName;
      document.getElementById('sessionActivity').textContent = translateActivity(result.activity);
      const confPct = Math.round((result.confidence || 0) * 100);
      document.getElementById('sessionConf').textContent =
        confPct + '%' + (result.cat_identity === 'unknown' ? ' âš ï¸' : '');

    } catch (e) {
      console.error('JSON parse error', text);
    }
  } catch (e) {
    console.error('API fetch error', e);
  }

  setCamStatus('ğŸ”´ é€²è¡Œä¸­', 'in-session');
}

function translateActivity(act) {
  const m = { urinating: 'ğŸ’§ å°¿å°¿', defecating: 'ğŸ’© å¤§ä¾¿', investigating: 'ğŸ‘€ æ¢ç´¢', covering: 'â› æ©è“‹', exiting: 'ğŸšª é›¢é–‹', none: 'â€”' };
  return m[act] || act || 'â€”';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildNotifMessage(entry, alerts) {
  const s = loadSettings();
  const dot = entry.cat === 'cat1' ? s.cat1ColorDot : s.cat2ColorDot;
  const actEmoji = { urinating: 'ğŸ’§', defecating: 'ğŸ’©', investigating: 'ğŸ‘€', covering: 'â›', exiting: 'ğŸšª' };
  const emoji = actEmoji[entry.activity] || 'ğŸ±';
  const dur = entry.duration < 60 ? `${entry.duration}ç§’` : `${Math.round(entry.duration/60)}åˆ†`;
  const time = new Date(entry.timestamp).toLocaleTimeString('zh-HK', {hour:'2-digit',minute:'2-digit'});

  let msg = `${emoji} **${entry.catName}** å»å’—å»æ‰€\n`;
  msg += `ğŸ• ${time} ï½œ â± ${dur}\n`;
  msg += `ğŸ“Š æ´»å‹•ï¼š${translateActivity(entry.activity)}\n`;
  if (entry.notes) msg += `ğŸ“ ${entry.notes}\n`;
  if (alerts.length > 0) {
    msg += '\nâš ï¸ **å¥åº·è­¦å‘Š**\n';
    alerts.forEach(a => msg += `â€¢ ${a.msg}\n`);
  }
  return msg;
}

async function sendNotifications(entry, s, alerts) {
  const msg = buildNotifMessage(entry, alerts);

  if (s.discordWebhook) {
    try {
      await fetch(s.discordWebhook, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: msg, username: 'ğŸ± è²“å»ç›£å¯Ÿç«™' })
      });
    } catch (e) { console.error('Discord error', e); }
  }

  if (s.tgToken && s.tgChatId) {
    const tgMsg = msg.replace(/\*\*/g, '*');
    try {
      await fetch(`https://api.telegram.org/bot${s.tgToken}/sendMessage`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: s.tgChatId, text: tgMsg, parse_mode: 'Markdown' })
      });
    } catch (e) { console.error('Telegram error', e); }
  }
}

async function testDiscord() {
  const url = document.getElementById('discordWebhook').value;
  if (!url) { toast('è«‹å…ˆå¡«å¯« Discord Webhook URL', 'error'); return; }
  try {
    await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content: 'âœ… è²“å»ç›£å¯Ÿç«™é€£æ¥æ¸¬è©¦æˆåŠŸï¼ğŸ±', username: 'ğŸ± è²“å»ç›£å¯Ÿç«™' })
    });
    toast('âœ… Discord æ¸¬è©¦æˆåŠŸ', 'success');
  } catch (e) { toast('âŒ Discord æ¸¬è©¦å¤±æ•—: ' + e.message, 'error'); }
}

async function testTelegram() {
  const token = document.getElementById('tgToken').value;
  const chatId = document.getElementById('tgChatId').value;
  if (!token || !chatId) { toast('è«‹å¡«å¯« Telegram Token åŒ Chat ID', 'error'); return; }
  try {
    const r = await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chat_id: chatId, text: 'âœ… è²“å»ç›£å¯Ÿç«™é€£æ¥æ¸¬è©¦æˆåŠŸï¼ğŸ±' })
    });
    const d = await r.json();
    if (d.ok) toast('âœ… Telegram æ¸¬è©¦æˆåŠŸ', 'success');
    else toast('âŒ Telegram éŒ¯èª¤: ' + d.description, 'error');
  } catch (e) { toast('âŒ Telegram æ¸¬è©¦å¤±æ•—: ' + e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROI CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupROICanvas() {
  const canvas = document.getElementById('roiCanvas');
  const video = document.getElementById('videoEl');

  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;

  canvas.addEventListener('touchstart', onROIStart, { passive: false });
  canvas.addEventListener('touchmove', onROIMove, { passive: false });
  canvas.addEventListener('touchend', onROIEnd);
  canvas.addEventListener('mousedown', onROIStart);
  canvas.addEventListener('mousemove', onROIMove);
  canvas.addEventListener('mouseup', onROIEnd);
}

function getPos(e, canvas) {
  const r = canvas.getBoundingClientRect();
  const touch = e.touches ? e.touches[0] : e;
  return { x: (touch.clientX - r.left) / r.width, y: (touch.clientY - r.top) / r.height };
}

function onROIStart(e) {
  e.preventDefault();
  const canvas = document.getElementById('roiCanvas');
  roiStart = getPos(e, canvas);
  isDrawingROI = true;
}

function onROIMove(e) {
  e.preventDefault();
  if (!isDrawingROI) return;
  const canvas = document.getElementById('roiCanvas');
  const pos = getPos(e, canvas);
  roi = {
    x: Math.min(roiStart.x, pos.x),
    y: Math.min(roiStart.y, pos.y),
    w: Math.abs(pos.x - roiStart.x),
    h: Math.abs(pos.y - roiStart.y)
  };
  drawROI();
}

function onROIEnd(e) {
  isDrawingROI = false;
  if (roi && roi.w < 0.05) { roi = null; drawROI(); }
}

function drawROI() {
  const canvas = document.getElementById('roiCanvas');
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!roi) return;
  const W = canvas.width, H = canvas.height;
  ctx.strokeStyle = '#00e5b0';
  ctx.lineWidth = 2;
  ctx.setLineDash([6, 3]);
  ctx.strokeRect(roi.x * W, roi.y * H, roi.w * W, roi.h * H);
  ctx.fillStyle = 'rgba(0,229,176,0.08)';
  ctx.fillRect(roi.x * W, roi.y * H, roi.w * W, roi.h * H);
  ctx.setLineDash([]);
  ctx.fillStyle = '#00e5b0';
  ctx.font = '10px Space Mono, monospace';
  ctx.fillText('è²“ç ‚ç›¤å€åŸŸ', roi.x * W + 4, roi.y * H + 14);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRecentEvents() {
  const logs = getLogs().slice(0, 5);
  const el = document.getElementById('recentEvents');
  if (logs.length === 0) { el.innerHTML = '<div class="no-events">å°šç„¡è¨˜éŒ„</div>'; return; }
  const s = loadSettings();
  el.innerHTML = logs.map(l => renderEventItem(l, s)).join('');
}

function renderEventItem(l, s) {
  const color = l.cat === 'cat1' ? s.cat1ColorDot : l.cat === 'cat2' ? s.cat2ColorDot : '#5a7a96';
  const badgeClass = l.activity === 'urinating' ? 'pee' : l.activity === 'defecating' ? 'poop' : 'visit';
  const time = formatTime(new Date(l.timestamp));
  const dur = l.duration < 60 ? l.duration + 's' : Math.round(l.duration/60) + 'm';
  const alertStr = l.alerts?.length > 0 ? `<span class="badge alert">âš ï¸ è­¦å‘Š</span>` : '';
  return `<div class="event-item">
    <div class="event-cat-dot" style="background:${color}"></div>
    <div class="event-body">
      <div class="event-title">${l.catName} Â· ${translateActivity(l.activity)}</div>
      <div class="event-sub">${dur} Â· ä¿¡å¿ƒ ${l.confidence}%</div>
    </div>
    ${alertStr}
    <span class="badge ${badgeClass}">${l.activity === 'urinating' ? 'å°¿' : l.activity === 'defecating' ? 'ä¾¿' : 'æ¢'}</span>
    <div class="event-time">${time}</div>
  </div>`;
}

function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderLog();
}

function renderLog() {
  const s = loadSettings();
  let logs = getLogs();

  if (currentFilter === 'cat1') logs = logs.filter(l => l.cat === 'cat1');
  else if (currentFilter === 'cat2') logs = logs.filter(l => l.cat === 'cat2');
  else if (currentFilter === 'pee') logs = logs.filter(l => l.activity === 'urinating');
  else if (currentFilter === 'poop') logs = logs.filter(l => l.activity === 'defecating');
  else if (currentFilter === 'alert') logs = logs.filter(l => l.alerts?.length > 0);

  const el = document.getElementById('logContainer');
  if (logs.length === 0) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“‹</div>ç„¡è¨˜éŒ„</div>';
    return;
  }

  // Group by date
  const groups = {};
  logs.forEach(l => {
    const d = new Date(l.timestamp).toLocaleDateString('zh-HK', {year:'numeric',month:'long',day:'numeric'});
    if (!groups[d]) groups[d] = [];
    groups[d].push(l);
  });

  el.innerHTML = Object.entries(groups).map(([date, entries]) => `
    <div class="log-date-group">
      <div class="log-date-label">${date}</div>
      ${entries.map(l => renderLogEntry(l, s)).join('')}
    </div>
  `).join('');
}

function renderLogEntry(l, s) {
  const color = l.cat === 'cat1' ? s.cat1ColorDot : l.cat === 'cat2' ? s.cat2ColorDot : '#5a7a96';
  const time = new Date(l.timestamp).toLocaleTimeString('zh-HK', {hour:'2-digit',minute:'2-digit'});
  const dur = l.duration < 60 ? l.duration + 'ç§’' : Math.round(l.duration/60) + 'åˆ†é˜';
  const alertHtml = l.alerts?.length ? l.alerts.map(a =>
    `<div class="alert-card ${a.type === 'warn' ? 'warn' : ''}" style="margin-top:6px;padding:8px">
      <div class="alert-title">${a.type === 'warn' ? 'âš ï¸' : 'ğŸš¨'} å¥åº·è­¦å‘Š</div>
      <div class="alert-body">${a.msg}</div>
    </div>`).join('') : '';

  return `<div class="log-entry">
    <div class="log-entry-header">
      <div class="event-cat-dot" style="background:${color}"></div>
      <strong style="font-size:13px;color:var(--text-bright)">${l.catName}</strong>
      <span class="badge ${l.activity === 'urinating' ? 'pee' : l.activity === 'defecating' ? 'poop' : 'visit'}">${translateActivity(l.activity)}</span>
      <span style="margin-left:auto;font-size:11px;color:var(--text-dim)">${time}</span>
    </div>
    ${l.notes ? `<div class="log-entry-notes">ã€Œ${l.notes}ã€</div>` : ''}
    ${l.identBasis ? `<div class="log-entry-notes" style="color:var(--teal-dim)">ğŸ” ${l.identBasis}</div>` : ''}
    <div class="log-entry-meta">
      <span>â± ${dur}</span>
      <span>ğŸ¯ ${l.confidence}%</span>
    </div>
    ${alertHtml}
  </div>`;
}

function renderStats() {
  const s = loadSettings();
  const logs = getLogs().filter(l => l.cat !== undefined);
  const el = document.getElementById('statsContainer');

  if (logs.length === 0) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“Š</div>æ”¶é›†åˆ°è¨˜éŒ„å¾Œæœƒé¡¯ç¤ºçµ±è¨ˆ</div>';
    return;
  }

  const now = new Date();
  const today = now.toDateString();
  const weekAgo = new Date(now - 7*24*3600000);

  function catStats(cat, name, color) {
    const catLogs = logs.filter(l => l.cat === cat);
    const todayLogs = catLogs.filter(l => new Date(l.timestamp).toDateString() === today);
    const weekLogs = catLogs.filter(l => new Date(l.timestamp) >= weekAgo);
    const lastVisit = catLogs[0];
    const peeCount = weekLogs.filter(l => l.activity === 'urinating').length;
    const poopCount = weekLogs.filter(l => l.activity === 'defecating').length;
    const avgDur = weekLogs.length ? Math.round(weekLogs.reduce((a,l)=>a+l.duration,0)/weekLogs.length) : 0;
    const lastStr = lastVisit ? relativeTime(new Date(lastVisit.timestamp)) : 'ç„¡è¨˜éŒ„';

    return `<div class="cat-panel">
      <div class="cat-header">
        <div class="cat-avatar" style="background:${color}22;border:2px solid ${color}">ğŸ±</div>
        <div>
          <div class="cat-name">${name}</div>
          <div style="font-size:10px;color:var(--text-dim)">ä¸Šæ¬¡ï¼š${lastStr}</div>
        </div>
      </div>
      <div class="cat-stats">
        <div class="mini-stat"><div class="val">${todayLogs.length}</div><div class="lbl">ä»Šæ—¥æ¬¡æ•¸</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--blue)">${peeCount}</div><div class="lbl">æœ¬é€±å°¿å°¿</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--amber)">${poopCount}</div><div class="lbl">æœ¬é€±å¤§ä¾¿</div></div>
      </div>
      <div style="margin-top:8px;font-size:10px;color:var(--text-dim)">å¹³å‡æ¯æ¬¡ ${avgDur}ç§’ ï½œ æœ¬é€± ${weekLogs.length} æ¬¡</div>
    </div>`;
  }

  // Alerts
  const alerts = generateHealthAlerts(logs, s);
  const alertHtml = alerts.map(a => `
    <div class="alert-card ${a.type === 'warn' ? 'warn' : ''}">
      <div class="alert-title">${a.type === 'warn' ? 'âš ï¸ æ³¨æ„' : 'ğŸš¨ è­¦å‘Š'}</div>
      <div class="alert-body">${a.msg}</div>
    </div>`).join('');

  // Timeline for today
  const timelineHtml = renderTimeline(logs, s, today);

  const totalWeek = logs.filter(l => new Date(l.timestamp) >= weekAgo).length;

  el.innerHTML = `
    ${alertHtml}
    ${catStats('cat1', s.cat1Name, s.cat1ColorDot)}
    ${catStats('cat2', s.cat2Name, s.cat2ColorDot)}
    <div class="section-title">ä»Šæ—¥æ™‚é–“è»¸</div>
    ${timelineHtml}
    <div class="stats-grid" style="margin-top:8px">
      <div class="stat-card"><div class="stat-val">${totalWeek}</div><div class="stat-label">æœ¬é€±ç¸½è¨˜éŒ„</div></div>
      <div class="stat-card"><div class="stat-val">${logs.length}</div><div class="stat-label">å…¨éƒ¨è¨˜éŒ„</div></div>
    </div>
  `;
}

function renderTimeline(logs, s, today) {
  const todayLogs = logs.filter(l => new Date(l.timestamp).toDateString() === today);
  const cat1Today = todayLogs.filter(l => l.cat === 'cat1');
  const cat2Today = todayLogs.filter(l => l.cat === 'cat2');

  function eventBars(catLogs, color) {
    return catLogs.map(l => {
      const d = new Date(l.timestamp);
      const pct = (d.getHours() * 60 + d.getMinutes()) / (24 * 60) * 100;
      const durPct = Math.max(0.5, (l.duration / 86400) * 100);
      const c = l.activity === 'urinating' ? '#4dd0e1' : l.activity === 'defecating' ? '#ffb74d' : color;
      return `<div class="timeline-event" style="left:${pct}%;width:${durPct}%;background:${c};opacity:0.85"></div>`;
    }).join('');
  }

  return `<div class="timeline-wrap">
    <div class="timeline-hours">
      ${['0','6','12','18','24'].map(h=>`<span>${h}</span>`).join('')}
    </div>
    <div class="timeline-row">
      <div class="timeline-cat-label">${s.cat1Name}</div>
      <div class="timeline-bar">${eventBars(cat1Today, s.cat1ColorDot)}</div>
    </div>
    <div class="timeline-row">
      <div class="timeline-cat-label">${s.cat2Name}</div>
      <div class="timeline-bar">${eventBars(cat2Today, s.cat2ColorDot)}</div>
    </div>
    <div style="display:flex;gap:12px;margin-top:6px;font-size:9px;color:var(--text-dim)">
      <span style="color:#4dd0e1">â–  å°¿å°¿</span>
      <span style="color:#ffb74d">â–  å¤§ä¾¿</span>
    </div>
  </div>`;
}

function generateHealthAlerts(logs, s) {
  const alerts = [];
  const now = new Date();

  ['cat1', 'cat2'].forEach(cat => {
    const name = cat === 'cat1' ? s.cat1Name : s.cat2Name;
    const catLogs = logs.filter(l => l.cat === cat);
    if (catLogs.length === 0) return;

    const last = new Date(catLogs[0].timestamp);
    const hoursSince = (now - last) / 3600000;

    if (s.alertNoVisit > 0 && hoursSince > s.alertNoVisit) {
      alerts.push({ type: 'alert', msg: `${name} è¶…é ${Math.round(hoursSince)} å°æ™‚æœªæœ‰å¦‚å»è¨˜éŒ„` });
    }

    const today = now.toDateString();
    const todayCount = catLogs.filter(l => new Date(l.timestamp).toDateString() === today).length;
    if (todayCount >= s.alertMaxDaily) {
      alerts.push({ type: 'warn', msg: `${name} ä»Šæ—¥å·²å¦‚å» ${todayCount} æ¬¡ï¼Œæ¬¡æ•¸åå¤š` });
    }
  });

  return alerts;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + tab).classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');

  if (tab === 'log') renderLog();
  if (tab === 'stats') renderStats();
}

function setStatusDot(state) {
  const dot = document.getElementById('statusDot');
  dot.className = 'status-dot' + (state ? ' ' + state : '');
}

function setOverlay(text) {
  document.getElementById('camOverlay').textContent = text;
}

function setCamStatus(text, cls) {
  const el = document.getElementById('camStatus');
  el.textContent = text;
  el.className = 'cam-status' + (cls ? ' ' + cls : '');
}

function updateMotionMeter(pct) {
  const fill = document.getElementById('motionFill');
  const label = document.getElementById('motionVal');
  fill.style.width = pct + '%';
  fill.className = 'meter-fill' + (pct > 60 ? ' fire' : pct > 30 ? ' hot' : '');
  label.textContent = pct + '%';
}

function formatTime(d) {
  return d.toLocaleTimeString('zh-HK', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}

function relativeTime(d) {
  const secs = Math.round((Date.now() - d) / 1000);
  if (secs < 60) return `${secs}ç§’å‰`;
  if (secs < 3600) return `${Math.round(secs/60)}åˆ†å‰`;
  if (secs < 86400) return `${Math.round(secs/3600)}å°æ™‚å‰`;
  return `${Math.round(secs/86400)}æ—¥å‰`;
}

let toastTimer;
function toast(msg, type = '') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast show' + (type ? ' ' + type : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  loadSettingsToForm();
  renderRecentEvents();

  const s = loadSettings();
  if (s.apiKey) {
    document.getElementById('setupOverlay').classList.add('hidden');
  }

  // Daily health check
  setInterval(() => {
    const s = loadSettings();
    const alerts = generateHealthAlerts(getLogs(), s);
    if (alerts.length > 0) {
      sendNotifications({ catName: 'å¥åº·ç›£å¯Ÿ', cat: 'none', activity: 'none', duration: 0, confidence: 0, notes: '', timestamp: new Date().toISOString() }, s, alerts);
    }
  }, 6 * 3600 * 1000); // Every 6 hours
}

init();
</script>
</body>
</html>
